<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONIUNGITE</title>
  <style>
    :root {
      --bg: #050816;
      --bg-soft: #060b1b;
      --tile: #0b1120;
      --tile-border: #1e293b;
      --tile-glow: #38bdf8;
      --accent: #38bdf8;
      --accent-soft: #0f172a;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }

    html {
      font-size: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.08), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(59, 130, 246, 0.18), transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(8, 47, 73, 0.9), #020617 70%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: radial-gradient(circle at top, #020617, #020617 55%);
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: 0 18px 30px rgba(15, 23, 42, 0.9);
    }

    .header-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 0.6rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .logo-block {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      border-radius: 0.6rem;
      transition: all 0.2s ease;
    }

    .logo-block:hover {
      background: rgba(56, 189, 248, 0.1);
    }

    .logo-main {
      font-size: 1rem;
      letter-spacing: 0.38em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .logo-sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
    }

    select,
    button {
      font-size: 0.7rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      padding: 0.32rem 0.8rem;
      cursor: pointer;
    }

    .mode-toggle {
      display: flex;
      gap: 0.3rem;
    }

    .mode-btn {
      padding: 0.32rem 0.6rem;
      font-size: 0.75rem;
      background: #0f172a;
      border: 1px solid #1f2937;
    }

    .mode-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #020617;
    }

    .btn-ghost.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    .editor-view {
      display: none;
    }

    .editor-view.active {
      display: block;
    }

    .editor-panel {
      width: min(1100px, 96vw);
      margin: 0 auto;
      padding: 1rem;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      border: 1px solid rgba(15, 23, 42, 0.95);
      border-radius: 1.5rem;
    }

    .editor-section {
      margin-bottom: 0.8rem;
      padding: 0.7rem;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid #1e293b;
      border-radius: 0.8rem;
    }

    .editor-section h3 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .form-group {
      margin-bottom: 0.5rem;
    }

    .form-group label {
      display: block;
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 0.2rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.3rem;
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 0.5rem;
      color: var(--text-main);
      font-family: inherit;
      font-size: 0.7rem;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 40px;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      border-color: #38bdf8;
      color: #020617;
      font-weight: 600;
      padding: 0.5rem 1rem;
    }

    .btn-primary:hover {
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
    }

    .btn-secondary {
      background: #0f172a;
      border-color: #1f2937;
      color: var(--text-main);
      padding: 0.4rem 0.8rem;
      font-size: 0.75rem;
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #fca5a5;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .questions-list {
      display: grid;
      gap: 0.8rem;
    }

    .question-item {
      padding: 0.8rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid #334155;
      border-radius: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .question-item-text {
      flex: 1;
      font-size: 0.85rem;
    }

    .question-item-actions {
      display: flex;
      gap: 0.3rem;
    }

    .clues-container {
      display: grid;
      gap: 0.5rem;
    }

    .clue-input {
      display: flex;
      gap: 0.3rem;
      align-items: center;
    }

    .clue-input input {
      flex: 1;
    }

    .btn-sm {
      padding: 0.3rem 0.6rem;
      font-size: 0.7rem;
    }

    .timer-container {
      padding: 0.5rem 0;
      display: none;
    }

    .timer-container.active {
      display: block;
    }

    .timer-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 0.3rem;
    }

    .timer-bar-wrapper {
      width: 100%;
      height: 8px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid rgba(30, 64, 175, 0.3);
    }

    .timer-bar {
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #0ea5e9);
      width: 100%;
      transition: width 0.3s linear;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
    }

    .timer-bar.warning {
      background: linear-gradient(90deg, #fbbf24, #f59e0b);
      box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
    }

    .timer-bar.danger {
      background: linear-gradient(90deg, #ef4444, #dc2626);
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    }

    .timer-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.3rem;
    }

    .timer-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: monospace;
    }

    .timer-controls {
      display: flex;
      gap: 0.4rem;
    }

    .timer-btn {
      padding: 0.2rem 0.5rem;
      font-size: 0.6rem;
      background: #0f172a;
      border: 1px solid #1f2937;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .timer-btn:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }

    select {
      padding-right: 2rem;
      background: #020617;
    }

    select:hover,
    button:hover {
      border-color: var(--accent);
    }

    .start-tile {
      border-radius: 1rem;
      border: 2px solid var(--tile-border);
      background: radial-gradient(circle at 20% 0%, #1d2a3b, #020617 60%);
      color: var(--text-main);
      padding: 1rem;
      cursor: pointer;
      box-shadow:
        0 20px 50px rgba(0, 0, 0, 0.85),
        0 0 0 2px rgba(15, 23, 42, 0.9);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, border-color 0.12s ease-out;
      text-align: center;
    }

    .start-tile:hover {
      transform: translateY(-2px);
      border-color: var(--tile-glow);
      box-shadow:
        0 25px 60px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(56, 189, 248, 0.6);
    }

    main {
      width: min(1200px, 96vw);
      margin: 0 auto;
      padding: 1.2rem 1.2rem 1.6rem;
      flex: 1;
    }

    .board-shell {
      border-radius: 1.5rem;
      border: 1px solid rgba(15, 23, 42, 0.95);
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      box-shadow:
        0 30px 100px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      padding: 1.4rem 1.6rem 1.6rem;
      position: relative;
      overflow: hidden;
    }

    .board-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 50% -10%, rgba(56, 189, 248, 0.23), transparent 55%),
        radial-gradient(circle at -10% 110%, rgba(56, 189, 248, 0.12), transparent 55%);
      opacity: 0.7;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .board-inner {
      position: relative;
      z-index: 1;
    }

    .breadcrumbs {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin-bottom: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .breadcrumbs-path span + span::before {
      content: " � ";
      opacity: 0.7;
    }

    .breadcrumbs button {
      font-size: 0.7rem;
      padding: 0.22rem 0.7rem;
    }

    .round-tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .round-tab {
      border-radius: 999px;
      padding: 0.32rem 0.9rem;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-muted);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .round-tab.active {
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      border-color: #e0f2fe;
      color: #020617;
      font-weight: 600;
      box-shadow: 0 0 25px rgba(56, 189, 248, 0.7);
    }

    .round-tab:hover {
      border-color: var(--accent);
    }

    .glyph-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.7rem;
      padding: 0.6rem 0;
    }

    @media (max-width: 800px) {
      .glyph-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 520px) {
      main {
        padding-inline: 0.75rem;
      }
      .board-shell {
        padding-inline: 1.2rem;
      }
    }

    .glyph-card {
      position: relative;
      border-radius: 1.1rem;
      border: 2px solid var(--tile-border);
      background: radial-gradient(circle at 20% 0%, #1d2a3b, #020617 60%);
      box-shadow:
        0 20px 50px rgba(0, 0, 0, 0.85),
        0 0 0 2px rgba(15, 23, 42, 0.9);
      padding: 0.75rem;
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, border-color 0.12s ease-out;
      aspect-ratio: 4 / 3;
      width: 100%;
      height: auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .glyph-card.used {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #334155;
    }

    .glyph-card:disabled {
      pointer-events: none;
    }

    .sparkle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: radial-gradient(circle, #fef3c7, #f59e0b 60%, transparent 70%);
      opacity: 0.9;
      animation: sparkle 1.2s ease-out forwards;
      pointer-events: none;
    }

    @keyframes sparkle {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-140px) scale(0.2); opacity: 0; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    @keyframes glow {
      0%, 100% { filter: drop-shadow(0 0 10px currentColor); }
      50% { filter: drop-shadow(0 0 30px currentColor) drop-shadow(0 0 40px currentColor); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .glyph-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 50% 0%, rgba(56, 189, 248, 0.2), transparent 55%),
        radial-gradient(circle at 10% 120%, rgba(37, 99, 235, 0.4), transparent 55%);
      opacity: 0;
      transition: opacity 0.12s ease-out;
      mix-blend-mode: screen;
    }

    .glyph-card:hover {
      transform: translateY(-2px);
      border-color: var(--tile-glow);
      box-shadow:
        0 25px 60px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(56, 189, 248, 0.6);
    }

    .glyph-card:hover::before {
      opacity: 1;
    }

    .glyph-inner {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .glyph-inner img {
      max-height: 62%;
      max-width: 62%;
      display: block;
      filter: drop-shadow(0 8px 16px rgba(15, 23, 42, 0.8));
    }

    .glyph-fallback {
      width: 64%;
      height: 64%;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: #e5e7eb;
      background: radial-gradient(circle at 50% 0%, #0f172a, #020617 70%);
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .question-view {
      display: none;
      min-height: 100vh;
    }

    .question-view.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-view.question-mode {
      min-height: 0;
    }

    .question-view.active.question-mode {
      align-items: flex-start;
      padding-top: 0.6rem;
    }

    .vowels-layout {
      width: 100%;
      max-width: 760px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
      align-items: stretch;
      text-align: center;
    }

    .vowels-topic {
      background: linear-gradient(135deg, #0c1734, #102554);
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: #dce9ff;
      padding: 0.65rem 1rem;
      border-radius: 0.8rem;
      font-size: 0.95rem;
      letter-spacing: 0.06em;
      box-shadow: inset 0 -2px 8px rgba(0, 0, 0, 0.35), 0 10px 28px rgba(0, 0, 0, 0.55);
    }

    .vowels-clue {
      background: linear-gradient(120deg, #d8ecff, #c0dcff);
      color: #0c1a38;
      padding: 0.9rem 1rem;
      border-radius: 0.8rem;
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      border: 1px solid rgba(15, 23, 42, 0.3);
      box-shadow: inset 0 -2px 10px rgba(255, 255, 255, 0.45), 0 12px 24px rgba(0, 0, 0, 0.4);
      font-family: "Segoe UI", system-ui, sans-serif;
    }

    .vowels-status {
      color: var(--text-muted);
      font-size: 0.8rem;
      letter-spacing: 0.06em;
    }

    .vowels-controls {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .vowels-controls .btn-accent,
    .vowels-controls .btn-secondary,
    .vowels-controls .btn-ghost {
      min-width: 120px;
    }

    .clue-panel {
      border-radius: 1.1rem;
      border: 1px solid rgba(30, 64, 175, 0.85);
      background: radial-gradient(circle at top, #020617, #020617 60%);
      padding: 0.8rem 0.9rem 0.9rem;
      box-shadow:
        0 18px 50px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(30, 64, 175, 0.8);
    }

    .clue-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.7rem;
      margin-bottom: 0.9rem;
    }

    @media (max-width: 640px) {
      .clue-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .clue-card {
      border-radius: 0.8rem;
      border: 1px solid rgba(30, 64, 175, 0.7);
      background: radial-gradient(circle at top, #020617, #020617 65%);
      padding: 0.6rem 0.7rem;
      min-height: 48px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .clue-card.hidden {
      border-style: dashed;
      border-color: #1d3553;
      color: #4b5563;
    }

    .clue-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin-bottom: 0.1rem;
    }

    .clue-text {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      margin-top: 0.3rem;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }

    .btn-ghost {
      background: transparent;
      border-color: #1f2937;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }

    .btn-accent {
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      border-color: #e0f2fe;
      color: #020617;
      font-weight: 600;
      box-shadow:
        0 10px 25px rgba(56, 189, 248, 0.65),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .btn-accent:hover {
      filter: brightness(1.03);
    }

    .answer-block {
      margin-top: 0.7rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(22, 163, 74, 0.8);
      background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.3), rgba(21, 128, 61, 0.08));
      padding: 0.75rem 0.9rem;
    }

    .answer-block h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-bottom: 0.25rem;
    }

    .answer-block p {
      font-size: 0.92rem;
    }

    .answer-block small {
      display: block;
      margin-top: 0.25rem;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Start Page Styles */
    .start-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      padding: 0rem 1.1rem 1.6rem;
      text-align: center;
      background: radial-gradient(circle at 50% 50%, rgba(56, 189, 248, 0.05) 0%, transparent 70%);
    }

    .start-page-logo {
      font-size: 4rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--accent), #0f88d9);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      animation: fadeInDown 0.8s ease;
    }

    .start-page-subtitle {
      font-size: 1.2rem;
      color: var(--text-muted);
      margin-bottom: 3rem;
      letter-spacing: 0.08em;
      animation: fadeInUp 0.8s ease 0.2s both;
    }

    .start-page-buttons {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      max-width: 420px;
      justify-content: center;
      flex-wrap: wrap;
      animation: fadeInUp 0.8s ease 0.4s both;
    }

    .start-btn {
      padding: 1rem 2rem;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      background: linear-gradient(135deg, var(--accent), #0f88d9);
      border: none;
      color: white;
      border-radius: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(56, 189, 248, 0.3);
    }

    .start-btn:active {
      transform: translateY(0);
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    footer {
      max-width: 960px;
      margin: 0 auto;
      padding: 0.35rem 1rem 0.8rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    /* Progress indicators */
    .progress-indicator {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.6);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    /* Point award animation */
    .point-award {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      font-weight: 800;
      color: var(--accent);
      z-index: 200;
      animation: pointPop 1.2s ease-out forwards;
      pointer-events: none;
      text-shadow: 0 0 30px rgba(56, 189, 248, 0.8);
    }

    @keyframes pointPop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      70% { opacity: 1; transform: translate(-50%, -60%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -80%) scale(0.8); }
    }

    /* Fullscreen button */
    .fullscreen-btn {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid var(--accent);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 50;
      transition: all 0.3s ease;
    }

    .fullscreen-btn:hover {
      background: rgba(56, 189, 248, 0.3);
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
      transform: scale(1.1);
    }

    .fullscreen-btn svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }

    /* Undo button styling */
    .undo-btn {
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
      background: rgba(251, 191, 36, 0.2);
      border: 1px solid #fbbf24;
      color: #fde68a;
      cursor: pointer;
      border-radius: 999px;
      transition: all 0.2s ease;
    }

    .undo-btn:hover {
      background: rgba(251, 191, 36, 0.3);
      border-color: #fde68a;
    }

    .undo-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Quiz management styles */
    .quiz-tools {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .quiz-tool-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.7rem;
      border-radius: 0.5rem;
      border: 1px solid #1e293b;
      background: rgba(56, 189, 248, 0.1);
      color: var(--accent);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quiz-tool-btn:hover {
      background: rgba(56, 189, 248, 0.2);
      border-color: var(--accent);
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.8rem;
      margin: 1rem 0;
    }

    .template-card {
      padding: 1rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid #334155;
      border-radius: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .template-card:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
      transform: translateY(-2px);
    }

    .template-card h4 {
      color: var(--accent);
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }

    .template-card p {
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    .version-item {
      padding: 0.6rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid #334155;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .version-info {
      flex: 1;
    }

    .version-timestamp {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .version-label {
      font-size: 0.75rem;
      color: var(--text-main);
      margin-top: 0.2rem;
    }

    .duplicate-warning {
      background: rgba(251, 191, 36, 0.2);
      border: 1px solid #fbbf24;
      color: #fde68a;
      padding: 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }

    .file-drop-zone {
      border: 2px dashed #334155;
      border-radius: 0.8rem;
      padding: 2rem;
      text-align: center;
      background: rgba(30, 41, 59, 0.3);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-drop-zone:hover,
    .file-drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
    }

    .csv-preview {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
      font-size: 0.7rem;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid #1e293b;
      border-radius: 0.5rem;
      padding: 0.5rem;
    }

    .csv-preview table {
      width: 100%;
      border-collapse: collapse;
    }

    .csv-preview th,
    .csv-preview td {
      padding: 0.3rem;
      border: 1px solid #334155;
      text-align: left;
    }

    .csv-preview th {
      background: rgba(56, 189, 248, 0.2);
      color: var(--accent);
      font-weight: 600;
    }

    /* Reuse questions modal */
    .reuse-quiz-list {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .reuse-quiz-item {
      padding: 0.6rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid #334155;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .reuse-quiz-item:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
    }

    .reuse-quiz-item.active {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.2);
    }

    .reuse-question-list {
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .reuse-question-card {
      padding: 0.8rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid #334155;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .reuse-question-card:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
    }

    .reuse-question-card.selected {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .reuse-question-card.selected::before {
      content: '✓ ';
      color: #22c55e;
      font-weight: bold;
      margin-right: 0.5rem;
    }

    .reuse-question-title {
      font-weight: 600;
      color: var(--accent);
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .reuse-question-details {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.3rem;
    }

    .reuse-question-preview {
      font-size: 0.75rem;
      color: var(--text-main);
      font-style: italic;
    }

    .reuse-selection-count {
      padding: 0.5rem;
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid var(--accent);
      border-radius: 0.5rem;
      text-align: center;
      font-size: 0.8rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="logo-block" id="logoBlock">
        <div class="logo-main">CONIUNGITE</div>
        <div class="logo-sub">Ludus Latinus</div>
      </div>
      <div class="header-controls">
        <div class="mode-toggle">
          <button class="mode-btn" id="editModeBtn">✏️ Create</button>
          <button class="mode-btn" id="setupModeBtn">⚙️ Setup</button>
          <button class="mode-btn" id="helpBtn" style="background:#1e3a8a;border-color:#2563eb;">📖 Help</button>
        </div>
        <div id="teamPanel" style="display:flex;align-items:center;gap:0.6rem;">
          <div style="display:flex;flex-direction:column;text-align:right;">
            <button class="btn-ghost" id="team1Btn" style="padding:0.25rem 0.6rem;font-size:0.7rem;">Team 1</button>
            <div style="font-size:0.75rem;color:var(--text-muted);">Score: <span id="team1Score">0</span></div>
          </div>
          <div style="display:flex;flex-direction:column;text-align:left;">
            <button class="btn-ghost" id="team2Btn" style="padding:0.25rem 0.6rem;font-size:0.7rem;">Team 2</button>
            <div style="font-size:0.75rem;color:var(--text-muted);">Score: <span id="team2Score">0</span></div>
          </div>
          <button class="btn-ghost" id="teamSetupBtn" title="Edit team names / reset scores" style="padding:0.25rem 0.6rem;font-size:0.7rem;">Team Setup</button>
          <button class="undo-btn" id="undoBtn" title="Undo last scoring action" style="padding:0.25rem 0.6rem;font-size:0.7rem;" disabled>↶ Undo</button>
          <button class="btn-secondary" id="newGameBtn" style="padding:0.25rem 0.6rem;font-size:0.7rem;">End Quiz</button>
        </div>
        <span class="pill-label">Year Group</span>
        <select id="yearGroupSelect"></select>
      </div>
    </div>
  </header>

  <!-- Fullscreen button -->
  <button class="fullscreen-btn" id="fullscreenBtn" title="Toggle fullscreen">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
    </svg>
  </button>

  <main>
    <div class="board-shell">
      <div class="board-inner">
        <div class="breadcrumbs">
          <div class="breadcrumbs-path" id="breadcrumbsPath"></div>
          <div id="breadcrumbsControls"></div>
        </div>

        <div class="round-tabs" id="roundTabs"></div>

        <div class="timer-container" id="timerContainer">
          <div class="timer-label">Round Timer</div>
          <div class="timer-bar-wrapper">
            <div class="timer-bar" id="timerBar"></div>
          </div>
          <div class="timer-display">
            <span class="timer-time" id="timerDisplay">3:00</span>
            <div class="timer-controls">
              <button class="timer-btn" id="timerStartBtn">Start</button>
              <button class="timer-btn" id="timerPauseBtn" style="display:none;">Pause</button>
              <button class="timer-btn" id="timerResetBtn">Reset</button>
            </div>
          </div>
        </div>

        <div id="questionList" class="glyph-grid"></div>

        <div id="questionView" class="question-view"></div>
      </div>
    </div>

    <div id="editorView" class="editor-view">
      <div class="editor-panel">
        <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--accent);">Create New Quiz</h2>

        <div class="editor-section">
          <h3>Quiz Tools</h3>
          <div class="quiz-tools">
            <button class="quiz-tool-btn" onclick="quizManager.showImportModal()">📥 Import CSV/Excel</button>
            <button class="quiz-tool-btn" onclick="quizManager.randomizeQuestions()">🔀 Randomize Questions</button>
            <button class="quiz-tool-btn" onclick="quizManager.detectDuplicates()">🔍 Check Duplicates</button>
            <button class="quiz-tool-btn" onclick="quizManager.showTemplates()">📋 Use Template</button>
            <button class="quiz-tool-btn" onclick="quizManager.showVersionHistory()">📜 Version History</button>
          </div>
        </div>

        <div class="editor-section" style="display:flex;gap:0.8rem;align-items:flex-end;flex-wrap:wrap;">
          <div style="flex:1;min-width:220px;">
            <label for="editorLoadSelect" style="display:block;font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:0.25rem;">Load existing quiz</label>
            <select id="editorLoadSelect" style="width:100%;padding:0.4rem 0.6rem;border-radius:0.6rem;border:1px solid #1e293b;background:#020617;color:var(--text-main);">
              <option value="">-- Select quiz --</option>
            </select>
          </div>
          <button class="btn-secondary" id="loadQuizBtn" style="padding:0.45rem 0.9rem;">Load into editor</button>
        </div>

        <div class="editor-section">
          <h3>Quiz Details</h3>
          <div class="form-group">
            <label for="quizName">Quiz Name</label>
            <input type="text" id="quizName" placeholder="e.g., Year 12 Latin - 2024 Set">
          </div>
          <div class="form-group">
            <label for="editorYear">Year</label>
            <select id="editorYear">
              <option value="">-- Select Year --</option>
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
              <option value="2022">2022</option>
            </select>
          </div>
          <div class="form-group">
            <label for="quizYear">Quiz ID</label>
            <input type="text" id="quizYear" placeholder="e.g., u6-latin-2024" title="Unique identifier for this quiz">
          </div>
        </div>

        <div class="editor-section">
          <h3>Round 1 � Connections</h3>
          <div id="connectionsQuestions" class="questions-list"></div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="btn-secondary btn-sm" onclick="editor.addQuestion('connections')">+ Add Question</button>
            <button class="btn-secondary btn-sm" onclick="quizManager.showReuseModal('connection')" style="background:rgba(56,189,248,0.15);border-color:var(--accent);" title="Reuse questions from other quizzes">↻ Reuse from Other Quizzes</button>
          </div>
        </div>

        <div class="editor-section">
          <h3>Round 2 � Sequences</h3>
          <div id="sequencesQuestions" class="questions-list"></div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="btn-secondary btn-sm" onclick="editor.addQuestion('sequence')">+ Add Question</button>
            <button class="btn-secondary btn-sm" onclick="quizManager.showReuseModal('sequence')" style="background:rgba(56,189,248,0.15);border-color:var(--accent);" title="Reuse questions from other quizzes">↻ Reuse from Other Quizzes</button>
          </div>
        </div>

        <div class="editor-section">
          <h3>Round 3 � Missing Vowels</h3>
          <div id="vowelsQuestions" class="questions-list"></div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="btn-secondary btn-sm" onclick="editor.addQuestion('vowels')">+ Add Question</button>
            <button class="btn-secondary btn-sm" onclick="quizManager.showReuseModal('vowels')" style="background:rgba(56,189,248,0.15);border-color:var(--accent);" title="Reuse questions from other quizzes">↻ Reuse from Other Quizzes</button>
          </div>
        </div>

        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: space-between; align-items:center; flex-wrap:wrap;">
          <div style="display:flex;gap:0.6rem;align-items:center;flex-wrap:wrap;">
            <button class="btn-primary" onclick="editor.save()">Save Quiz (Stay in Editor)</button>
            <button class="btn-secondary" onclick="editor.saveAndPlay()">Save & Play</button>
          </div>
          <div style="display:flex;gap:0.6rem;">
            <button class="btn-secondary" onclick="editor.clear()">Clear All</button>
            <button class="btn-danger" id="deleteQuizBtn" style="padding:0.45rem 0.9rem;">Delete quiz</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <span>HTML recreation styled in the spirit of the BBC "Only Connect" board for classroom use.</span>
    <span><a href="#" onclick="window.open('help.html','_blank');return false;">Help / Instructions</a></span>
  </footer>

  <script>
    // ----------------------------------------
    // QUIZ DATA
    // ----------------------------------------
    // Image files must be in the same folder, named:
    // glyph-lion.png, glyph-water.png, glyph-flax.png,
    // glyph-eye.png, glyph-two-reeds.png, glyph-horned-viper.png

    const quizData = {
      years: {
        2025: [
          {
            id: "l5lazz-2025",
            name: "L5LAZZ Christmas Quiz 2025",
            rounds: {
              connection: {
                label: "Round 1 � Connections",
                questions: [
                  {
                    glyph: "lion",
                    code: "Lion",
                    title: "",
                    type: "connection",
                    clues: ["Partridge", "Turtle doves", "French hens", "Calling birds"],
                    answer: "The first four gifts in the 12 Days of Christmas",
                    explanation: ""
                  }
                ]
              },
              sequence: {
                label: "Round 2 � Sequences",
                questions: [
                  {
                    glyph: "water",
                    code: "Seq",
                    title: "",
                    type: "sequence",
                    clues: ["I", "II", "III"],
                    answer: "IV",
                    explanation: ""
                  }
                ]
              },
              vowels: {
                label: "Round 3 � Missing vowels",
                questions: [
                  {
                    glyph: "flax",
                    code: "Vowels",
                    title: "",
                    type: "vowels",
                    clues: ["LZZCHRSTM S"],
                    answer: "LAZZ CHRISTMAS",
                    explanation: ""
                  }
                ]
              }
            }
          }
        ],
        2024: [
          {
            id: "u5-latin-2023",
            name: "Year 11 / U5 Latin � 2023 Set",
            rounds: {
            connection: {
              label: "Round 1 � Connections",
              questions: [
                {
                  glyph: "lion",
                  code: "Lion",
                  title: "Neuter nouns in Latin",
                  type: "connection",
                  clues: ["sea", "river", "camp", "war"],
                  answer: "They are all common neuter Latin nouns.",
                  explanation:
                    "Each English word corresponds to a Latin neuter noun (mare, flumen, castra, bellum).",
                },
                {
                  glyph: "water",
                  code: "Water",
                  title: "Labours of Heracles",
                  type: "connection",
                  clues: ["1 Lion", "3 Deer", "5 Stables", "7 Bull"],
                  answer: "They are the odd-numbered labours of Heracles.",
                  explanation:
                    "Each clue is shorthand for one of Heracles' labours: Nemean Lion (1), Ceryneian Hind (3), Augean Stables (5), Cretan Bull (7).",
                },
                {
                  glyph: "flax",
                  code: "Flax",
                  title: "1st conjugation verbs",
                  type: "connection",
                  clues: ["Love", "Wound", "Work", "Carry"],
                  answer: "All can be translated by first conjugation Latin verbs.",
                  explanation:
                    "Love (amo), wound (vulnero), work (laboro), carry (porto) are all 1st conjugation verbs in Latin.",
                },
                {
                  glyph: "eye",
                  code: "Eye",
                  title: "Harry Potter in Latin",
                  type: "connection",
                  clues: [
                    "Calix Ignis",
                    "Captivus Azkabani",
                    "Camera Secretorum",
                    "Philosophi Lapis",
                  ],
                  answer: "They are the first four Harry Potter book titles in Latin.",
                  explanation:
                    "These are the Latin titles for Goblet of Fire, Prisoner of Azkaban, Chamber of Secrets and Philosopher's Stone.",
                },
                {
                  glyph: "lion",
                  code: "Lion 2",
                  title: "Roman love poets",
                  type: "connection",
                  clues: ["Propertius", "Tibullus", "Catullus", "Ovid"],
                  answer: "They are all Roman love poets.",
                  explanation:
                    "All four are key poets of Roman love elegy (with Catullus as an important precursor).",
                },
              ],
            },
            sequence: {
              label: "Round 2 � Sequences",
              questions: [
                {
                  glyph: "lion",
                  code: "Emperors",
                  title: "Julio-Claudian emperors (no vowels)",
                  type: "sequence",
                  clues: ["CLDS", "GS", "TBRS"],
                  answer: "GSTS",
                  explanation:
                    "The first four emperors (in reverse order), with vowels removed: Claudius, Gaius (Caligula), Tiberius, Augustus.",
                },
                {
                  glyph: "water",
                  code: "Sagae",
                  title: "Sagae Thessalae locations",
                  type: "sequence",
                  clues: ["Miletus", "Olympia", "Thessaly"],
                  answer: "Larissa",
                  explanation:
                    "These are locations named in order in the Apuleius story Sagae Thessalae; Larissa is next.",
                },
                {
                  glyph: "flax",
                  code: "Planets",
                  title: "Planets by Roman deity",
                  type: "sequence",
                  clues: ["Mercury", "Venus", "Mars"],
                  answer: "Jupiter",
                  explanation:
                    "Planets in order from the Sun that have Roman deity names: Mercury, Venus, Earth (skipped), Mars, Jupiter � so Jupiter is the next Roman deity planet named.",
                },
                {
                  glyph: "eye",
                  code: "Song LAT",
                  title: "Heads, shoulders, knees, toes (Latin)",
                  type: "sequence",
                  clues: ["capita", "umeri", "genua"],
                  answer: "digiti",
                  explanation:
                    "It's the children's song: heads (capita), shoulders (umeri), knees (genua) and toes (digiti).",
                },
                {
                  glyph: "lion",
                  code: "Rotated",
                  title: "Rotated Roman numerals",
                  type: "sequence",
                  clues: ["I", "V", "X"],
                  answer: "L",
                  explanation:
                    "Roman numerals that still look like valid numerals when rotated 180�: I, V, X, L.",
                },
                {
                  glyph: "water",
                  code: "Vowel count",
                  title: "Decreasing vowel patterns",
                  type: "sequence",
                  clues: ["(4) quadrantaria", "(3) petentes", "(2) civis"],
                  answer: "(1) vox",
                  explanation:
                    "Latin words with decreasing numbers of the first four vowels in the alphabet: a/e/i/o. The final example has only one of these vowels.",
                },
              ],
            },
            vowels: {
              label: "Round 3 � Missing vowels",
              questions: [
                // Roman figures
                {
                  glyph: "lion",
                  code: "Romans 1",
                  title: "Roman figures",
                  type: "vowels",
                  clues: ["CCR"],
                  answer: "CICERO",
                  explanation: "Name of the Roman orator and statesman Marcus Tullius Cicero.",
                },
                {
                  glyph: "water",
                  code: "Romans 2",
                  title: "Roman figures",
                  type: "vowels",
                  clues: ["MR KN TN"],
                  answer: "MARK ANTONY",
                  explanation:
                    "The Roman politician and general Marcus Antonius (Mark Antony).",
                },
                {
                  glyph: "flax",
                  code: "Romans 3",
                  title: "Roman figures",
                  type: "vowels",
                  clues: ["MR CSRL S"],
                  answer: "MARCUS AURELIUS",
                  explanation: "The emperor-philosopher Marcus Aurelius.",
                },
                {
                  glyph: "eye",
                  code: "Romans 4",
                  title: "Roman figures",
                  type: "vowels",
                  clues: ["JL SCS R"],
                  answer: "JULIUS CAESAR",
                  explanation: "The famous general and dictator Gaius Julius Caesar.",
                },

                // 4th declension / domus set
                {
                  glyph: "lion",
                  code: "Decl. 1",
                  title: "4th declension forms",
                  type: "vowels",
                  clues: ["XRCT"],
                  answer: "EXERCITUI / EXERCITU",
                  explanation:
                    "Forms of exercitus (4th declension): dative singular (exercitui) or ablative singular (exercitu).",
                },
                {
                  glyph: "water",
                  code: "Decl. 2",
                  title: "4th declension forms",
                  type: "vowels",
                  clues: ["M NB S"],
                  answer: "MANIBUS",
                  explanation: "Dative / ablative plural of manus (hand).",
                },
                {
                  glyph: "flax",
                  code: "Decl. 3",
                  title: "4th declension forms",
                  type: "vowels",
                  clues: ["GNS"],
                  answer: "GENUS",
                  explanation:
                    "Listed on your slide with the 4th-declension set; a good prompt to discuss patterns.",
                },
                {
                  glyph: "eye",
                  code: "Decl. 4",
                  title: "4th declension forms",
                  type: "vowels",
                  clues: ["DMM"],
                  answer: "DOMUM / DOMUUM",
                  explanation:
                    "Forms from the domus paradigm: accusative singular (domum) or genitive plural (domuum).",
                },

                // Latin roots & derivatives
                {
                  glyph: "lion",
                  code: "Deriv. 1",
                  title: "Latin & English pair",
                  type: "vowels",
                  clues: ["RMN DRMR"],
                  answer: "ARMA & ARMOUR",
                  explanation: "Latin arma (arms, weapons) and English armour.",
                },
                {
                  glyph: "water",
                  code: "Deriv. 2",
                  title: "Latin & English pair",
                  type: "vowels",
                  clues: ["CRS NDPR CRSTNT"],
                  answer: "CRAS & PROCRASTINATE",
                  explanation:
                    "Latin cras (tomorrow) gives us part of procrastinate (put off until tomorrow).",
                },
                {
                  glyph: "flax",
                  code: "Deriv. 3",
                  title: "Latin & English pair",
                  type: "vowels",
                  clues: ["HR TSND HRT CLTR"],
                  answer: "HORTUS & HORTICULTURE",
                  explanation:
                    "Latin hortus (garden) is the root of horticulture (the art of garden cultivation).",
                },
                {
                  glyph: "eye",
                  code: "Deriv. 4",
                  title: "Latin & English pair",
                  type: "vowels",
                  clues: ["NM NNDN MNTV"],
                  answer: "NOMEN & NOMINATIVE",
                  explanation:
                    "Latin nomen (name) is connected to the grammatical term nominative (naming case).",
                },
              ],
            },
          },
        },
        {
          id: "fourth-form-xmas-23",
          name: "4th Form � Only Connect Christmas 2023",
          rounds: {
            connection: {
              label: "Round 1 � Connections",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "1st declension a",
                  title: "Alpha-variant endings",
                  type: "connection",
                  clues: ["?", "??", "?S", "?"],
                  answer: "They are 1st declension alpha variant endings in Greek.",
                  explanation: "Different case endings of Greek first-declension alpha-stem nouns."
                },
                {
                  glyph: "lion",
                  code: "Seven Wonders",
                  title: "Locations of Seven Wonders",
                  type: "connection",
                  clues: ["Rhodes", "Halicarnassus", "Alexandria", "Giza"],
                  answer: "They are locations of the Seven Wonders of the Ancient World.",
                  explanation: "Colossus of Rhodes, Mausoleum at Halicarnassus, Lighthouse at Alexandria, Pyramids at Giza."
                },
                {
                  glyph: "flax",
                  code: "Hills of Rome",
                  title: "Seven hills of Rome",
                  type: "connection",
                  clues: ["Viminal", "Esquiline", "Capitoline", "Palatine"],
                  answer: "They are four of the seven hills of Rome.",
                  explanation: "Four of the traditional seven hills on which Rome was founded."
                },
                {
                  glyph: "horned-viper",
                  code: "Farm animals",
                  title: "Farm animals in Latin",
                  type: "connection",
                  clues: ["gallus", "vacca", "porcus", "equus"],
                  answer: "They are all Latin words for farm animals.",
                  explanation: "gallus (cockerel), vacca (cow), porcus (pig), equus (horse)."
                },
                {
                  glyph: "water",
                  code: "Greek commanders",
                  title: "Greek commanders at Troy",
                  type: "connection",
                  clues: ["AGA", "AJA", "ACH", "ODY"],
                  answer: "They are the first three letters of Greek commanders at Troy.",
                  explanation: "Agamemnon, Ajax, Achilles, Odysseus."
                },
                {
                  glyph: "eye",
                  code: "Neuter nouns",
                  title: "Neuter in Latin & Greek",
                  type: "connection",
                  clues: ["gift", "arms", "prize", "temple"],
                  answer: "They are neuter nouns in both Latin and Greek.",
                  explanation: "Each English word stands for a neuter noun in both languages."
                }
              ]
            },
            sequence: {
              label: "Round 2 � Sequences",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "Roman numeral names",
                  title: "Names with increasing Roman numerals",
                  type: "sequence",
                  clues: ["Ian", "Victor", "Xavier"],
                  answer: "A name beginning with L (e.g. Liam).",
                  explanation: "Initial letters I, V, X, L are Roman numerals increasing in value; any L-name works as the fourth."
                },
                {
                  glyph: "lion",
                  code: "Philosophers",
                  title: "Philosophical students",
                  type: "sequence",
                  clues: ["Socrates", "Plato", "Aristotle"],
                  answer: "Alexander the Great",
                  explanation: "A chain of teacher�student: Socrates ? Plato ? Aristotle ? Alexander the Great."
                },
                {
                  glyph: "flax",
                  code: "Augustus split",
                  title: "First emperor in quarters",
                  type: "sequence",
                  clues: ["AU", "GU", "ST"],
                  answer: "US",
                  explanation: "The name AUGUSTUS split into four chunks: AU�GU�ST�US."
                },
                {
                  glyph: "horned-viper",
                  code: "Greek alphabet �7",
                  title: "Greek letters in multiples of 7",
                  type: "sequence",
                  clues: ["?", "?", "?"],
                  answer: "F",
                  explanation: "Every 7th letter of the Greek alphabet: 1st (?), 7th (?), 14th (?), 21st (F)."
                },
                {
                  glyph: "water",
                  code: "Principal parts",
                  title: "Principal parts notation",
                  type: "sequence",
                  clues: ["1P RE", "2I NF", "3P ER"],
                  answer: "4P PP",
                  explanation: "Abbreviations for the 4 principal parts of Latin verbs: 1st person, infinitive, perfect, PPP."
                },
                {
                  glyph: "eye",
                  code: "Emperors backwards",
                  title: "Julio-Claudian emperors (reverse)",
                  type: "sequence",
                  clues: ["Claudius", "Gaius", "Tiberius"],
                  answer: "Augustus",
                  explanation: "The first four emperors in reverse chronological order: Claudius, Gaius (Caligula), Tiberius, Augustus."
                }
              ]
            },
            vowels: {
              label: "Round 3 � Missing vowels",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "Gods 1",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["Z SN DJP TR"],
                  answer: "ZEUS AND JUPITER",
                  explanation: "Greek Zeus and his Roman equivalent Jupiter."
                },
                {
                  glyph: "lion",
                  code: "Gods 2",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["RSN DM RS"],
                  answer: "ARES AND MARS",
                  explanation: "Greek Ares and Roman Mars."
                },
                {
                  glyph: "flax",
                  code: "Gods 3",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["P HRD TN DVNS"],
                  answer: "APHRODITE AND VENUS",
                  explanation: "Greek Aphrodite and Roman Venus."
                },
                {
                  glyph: "horned-viper",
                  code: "Gods 4",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["PLL ND PLL"],
                  answer: "APOLLO AND APOLLO",
                  explanation: "Apollo has the same name in Greek and Latin."
                },
                {
                  glyph: "water",
                  code: "Iliad 1",
                  title: "Characters from the Iliad",
                  type: "vowels",
                  clues: ["CHLLS"],
                  answer: "ACHILLES",
                  explanation: "Hero of the Iliad on the Greek side."
                },
                {
                  glyph: "eye",
                  code: "Iliad 2",
                  title: "Characters from the Iliad",
                  type: "vowels",
                  clues: ["HC TR"],
                  answer: "HECTOR",
                  explanation: "Trojan prince and champion."
                },
                {
                  glyph: "two-reeds",
                  code: "Iliad 3",
                  title: "Characters from the Iliad",
                  type: "vowels",
                  clues: ["GM MN N"],
                  answer: "AGAMEMNON",
                  explanation: "Leader of the Greek forces at Troy."
                },
                {
                  glyph: "lion",
                  code: "Iliad 4",
                  title: "Characters from the Iliad",
                  type: "vowels",
                  clues: ["DS S S"],
                  answer: "ODYSSEUS",
                  explanation: "Cunning Greek hero."
                },
                {
                  glyph: "flax",
                  code: "Quote 1",
                  title: "Famous Latin quote",
                  type: "vowels",
                  clues: ["VNV DVC"],
                  answer: "VENI, VIDI, VICI",
                  explanation: "Caesar's 'I came, I saw, I conquered'."
                },
                {
                  glyph: "horned-viper",
                  code: "Quote 2",
                  title: "Famous Latin quote",
                  type: "vowels",
                  clues: ["CR PD M"],
                  answer: "CARPE DIEM",
                  explanation: "'Seize the day'."
                },
                {
                  glyph: "water",
                  code: "Quote 3",
                  title: "Famous Latin quote",
                  type: "vowels",
                  clues: ["TT BRT"],
                  answer: "ET TU, BRUTE?",
                  explanation: "'You too, Brutus?' said to Caesar's assassin."
                },
                {
                  glyph: "eye",
                  code: "Quote 4",
                  title: "Famous Latin quote",
                  type: "vowels",
                  clues: ["L CT ST"],
                  answer: "ALEA IACTA EST",
                  explanation: "'The die is cast'."
                },
                {
                  glyph: "two-reeds",
                  code: "Antonyms 1",
                  title: "Latin antonyms",
                  type: "vowels",
                  clues: ["LX TNX"],
                  answer: "LUX ET NOX",
                  explanation: "Light and night."
                },
                {
                  glyph: "lion",
                  code: "Antonyms 2",
                  title: "Latin antonyms",
                  type: "vowels",
                  clues: ["LT STT RSTS"],
                  answer: "LAETUS ET TRISTIS",
                  explanation: "Happy and sad."
                },
                {
                  glyph: "flax",
                  code: "Antonyms 3",
                  title: "Latin antonyms",
                  type: "vowels",
                  clues: ["MGN STP RVS"],
                  answer: "MAGNUS ET PARVUS",
                  explanation: "Big and small."
                },
                {
                  glyph: "horned-viper",
                  code: "Antonyms 4",
                  title: "Latin antonyms",
                  type: "vowels",
                  clues: ["FRT STGN VS"],
                  answer: "FORTIS ET IGNAVUS",
                  explanation: "Brave and cowardly."
                }
              ]
            }
          }
        },
        {
          id: "only-connect-quiz-1",
          name: "Only Connect � Quiz 1",
          rounds: {
            connection: {
              label: "Round 1 � Connections",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "Accusatives",
                  title: "Latin accusative endings",
                  type: "connection",
                  clues: ["AM", "AS", "UM", "OS"],
                  answer: "They are standard accusative endings in Latin.",
                  explanation: "-am, -as, -um, -os endings for different declensions."
                },
                {
                  glyph: "lion",
                  code: "Hills of Rome",
                  title: "Seven hills of Rome",
                  type: "connection",
                  clues: ["Viminal", "Esquiline", "Capitoline", "Palatine"],
                  answer: "They are four of the seven hills of Rome.",
                  explanation: "Part of the traditional seven hills."
                },
                {
                  glyph: "flax",
                  code: "Farm animals",
                  title: "Farm animals in Latin",
                  type: "connection",
                  clues: ["gallus", "vacca", "porcus", "equus"],
                  answer: "They are Latin nouns for farm animals.",
                  explanation: "Cockerel, cow, pig, horse."
                },
                {
                  glyph: "horned-viper",
                  code: "Seven Wonders",
                  title: "Locations of Seven Wonders",
                  type: "connection",
                  clues: ["Halicarnassus", "Rhodes", "Alexandria", "Giza"],
                  answer: "They are all locations of the Seven Wonders.",
                  explanation: "Mausoleum, Colossus, Lighthouse, Pyramids."
                }
              ]
            },
            sequence: {
              label: "Round 2 � Sequences",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "Deities A�D",
                  title: "Roman deities in alphabetical order",
                  type: "sequence",
                  clues: ["Apollo", "Bacchus", "Ceres"],
                  answer: "e.g. Diana (or Demeter, Dionysus)",
                  explanation: "Continuing an alphabetical list of deities."
                },
                {
                  glyph: "lion",
                  code: "Emperors 3-letter",
                  title: "Emperors, first three letters",
                  type: "sequence",
                  clues: ["CLA", "GAI", "TIB"],
                  answer: "AUG",
                  explanation: "Claudius, Gaius, Tiberius, Augustus."
                },
                {
                  glyph: "flax",
                  code: "Aeneas",
                  title: "Journey of Aeneas",
                  type: "sequence",
                  clues: ["Troy", "Carthage", "Sicily"],
                  answer: "Italy",
                  explanation: "Key stages of Aeneas' journey ending in Italy."
                },
                {
                  glyph: "horned-viper",
                  code: "Zeus' family",
                  title: "Lineage / descent of Zeus",
                  type: "sequence",
                  clues: ["Ga?a", "???a???", "??????"],
                  answer: "?e??",
                  explanation: "Family line: Gaia ? Ouranos ? Kronos ? Zeus."
                }
              ]
            },
            vowels: {
              label: "Round 3 � Missing vowels",
              questions: [
                {
                  glyph: "water",
                  code: "Gods 1",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["Z SN DJP TR"],
                  answer: "ZEUS AND JUPITER",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "eye",
                  code: "Gods 2",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["RSN DM RS"],
                  answer: "ARES AND MARS",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "two-reeds",
                  code: "Gods 3",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["P HRD TN DVNS"],
                  answer: "APHRODITE AND VENUS",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "lion",
                  code: "Gods 4",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["PLL ND PLL"],
                  answer: "APOLLO AND APOLLO",
                  explanation: "Apollo in both languages."
                },
                {
                  glyph: "flax",
                  code: "Verb 1",
                  title: "Latin verbs",
                  type: "vowels",
                  clues: ["MB LNT"],
                  answer: "AMBULANT",
                  explanation: "3rd person plural of ambulo."
                },
                {
                  glyph: "horned-viper",
                  code: "Verb 2",
                  title: "Latin verbs",
                  type: "vowels",
                  clues: ["HB"],
                  answer: "HABEO",
                  explanation: "1st person singular, 'I have'."
                },
                {
                  glyph: "water",
                  code: "Verb 3",
                  title: "Latin verbs",
                  type: "vowels",
                  clues: ["DVRNT"],
                  answer: "AUDIVERUNT",
                  explanation: "Perfect tense: 'they heard'."
                },
                {
                  glyph: "eye",
                  code: "Verb 4",
                  title: "Latin verbs",
                  type: "vowels",
                  clues: ["DC"],
                  answer: "DICO / DUCO",
                  explanation: "Two possible Latin verbs: dico or duco."
                },
                {
                  glyph: "two-reeds",
                  code: "Letter 1",
                  title: "Greek letter names",
                  type: "vowels",
                  clues: ["LP H"],
                  answer: "ALPHA",
                  explanation: "Greek letter name."
                },
                {
                  glyph: "lion",
                  code: "Letter 2",
                  title: "Greek letter names",
                  type: "vowels",
                  clues: ["G MM"],
                  answer: "GAMMA",
                  explanation: "Greek letter name."
                },
                {
                  glyph: "flax",
                  code: "Letter 3",
                  title: "Greek letter names",
                  type: "vowels",
                  clues: ["P S"],
                  answer: "PSI",
                  explanation: "Greek letter name."
                },
                {
                  glyph: "horned-viper",
                  code: "Letter 4",
                  title: "Greek letter names",
                  type: "vowels",
                  clues: ["PS LN"],
                  answer: "EPSILON / UPSILON",
                  explanation: "Ambiguous, could be Epsilon or Upsilon."
                }
              ]
            }
          }
        },
        {
          id: "y8-eoy",
          name: "Year 8 � Only Connect End-of-Year",
          rounds: {
            connection: {
              label: "Round 1 � Connections",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "1st declension a",
                  title: "Alpha-variant endings",
                  type: "connection",
                  clues: ["?", "??", "?S", "?"],
                  answer: "1st declension alpha variant endings.",
                  explanation: "Variant endings in Greek first-declension nouns."
                },
                {
                  glyph: "lion",
                  code: "Seven Wonders",
                  title: "Locations of Seven Wonders",
                  type: "connection",
                  clues: ["Rhodes", "Halicarnassus", "Alexandria", "Giza"],
                  answer: "Locations of the Seven Wonders of the Ancient World.",
                  explanation: "Colossus, Mausoleum, Lighthouse, Pyramids."
                },
                {
                  glyph: "flax",
                  code: "Hills of Rome",
                  title: "Seven hills of Rome",
                  type: "connection",
                  clues: ["Viminal", "Esquiline", "Capitoline", "Palatine"],
                  answer: "Four of the seven hills of Rome.",
                  explanation: "Classic Roman topography."
                },
                {
                  glyph: "horned-viper",
                  code: "Farm animals",
                  title: "Farm animals in Latin",
                  type: "connection",
                  clues: ["gallus", "vacca", "porcus", "equus"],
                  answer: "Latin nouns for farm animals.",
                  explanation: "Useful basic vocabulary."
                },
                {
                  glyph: "water",
                  code: "Greek commanders",
                  title: "Greek commanders at Troy",
                  type: "connection",
                  clues: ["AGA", "AJA", "ACH", "ODY"],
                  answer: "Initials of Greek commanders at Troy.",
                  explanation: "Agamemnon, Ajax, Achilles, Odysseus."
                },
                {
                  glyph: "eye",
                  code: "Neuter nouns",
                  title: "Neuter in Latin & Greek",
                  type: "connection",
                  clues: ["gift", "arms", "prize", "temple"],
                  answer: "Neuter nouns in both Latin and Greek.",
                  explanation: "Nouns treated as neuter in both languages."
                }
              ]
            },
            sequence: {
              label: "Round 2 � Sequences",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "Deities A�D",
                  title: "Roman deities in alphabetical order",
                  type: "sequence",
                  clues: ["Apollo", "Bacchus", "Ceres"],
                  answer: "e.g. Diana (or Demeter, Dionysus)",
                  explanation: "Continuing an alphabetical list of deities."
                },
                {
                  glyph: "lion",
                  code: "Philosophers",
                  title: "Philosophical students",
                  type: "sequence",
                  clues: ["Socrates", "Plato", "Aristotle"],
                  answer: "Alexander the Great",
                  explanation: "Student of Aristotle."
                },
                {
                  glyph: "flax",
                  code: "Emperors 3-letter",
                  title: "Emperors, first three letters",
                  type: "sequence",
                  clues: ["CLA", "GAI", "TIB"],
                  answer: "AUG",
                  explanation: "Claudius, Gaius, Tiberius, Augustus."
                },
                {
                  glyph: "horned-viper",
                  code: "Greek alphabet �7",
                  title: "Greek letters in multiples of 7",
                  type: "sequence",
                  clues: ["?", "?", "?"],
                  answer: "F",
                  explanation: "Every 7th letter from Alpha."
                },
                {
                  glyph: "water",
                  code: "Principal parts",
                  title: "Four principal parts (1�4)",
                  type: "sequence",
                  clues: ["1: Pre", "2: Inf", "3: Per"],
                  answer: "4: PPP",
                  explanation: "Pre(1st principal part), Inf(infinitive), Per(perfect), PPP(perfect passive participle)."
                },
                {
                  glyph: "eye",
                  code: "Zeus' family",
                  title: "Lineage / descent of Zeus",
                  type: "sequence",
                  clues: ["Ga?a", "???a???", "??????"],
                  answer: "?e??",
                  explanation: "Gaia ? Ouranos ? Kronos ? Zeus."
                }
              ]
            },
            vowels: {
              label: "Round 3 � Missing vowels",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "Gods 1",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["Z SN DJP TR"],
                  answer: "ZEUS AND JUPITER",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "lion",
                  code: "Gods 2",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["RSN DM RS"],
                  answer: "ARES AND MARS",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "flax",
                  code: "Gods 3",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["P HRD TN DVNS"],
                  answer: "APHRODITE AND VENUS",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "horned-viper",
                  code: "Gods 4",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["PLL ND PLL"],
                  answer: "APOLLO AND APOLLO",
                  explanation: "Apollo in both pantheons."
                },
                {
                  glyph: "water",
                  code: "CLC 1",
                  title: "CLC IV characters",
                  type: "vowels",
                  clues: ["HT RS"],
                  answer: "HATERIUS",
                  explanation: "Character from CLC Book IV."
                },
                {
                  glyph: "eye",
                  code: "CLC 2",
                  title: "CLC IV characters",
                  type: "vowels",
                  clues: ["P HRSN"],
                  answer: "EUPHROSYNE",
                  explanation: "Character from CLC Book IV."
                },
                {
                  glyph: "two-reeds",
                  code: "CLC 3",
                  title: "CLC IV characters",
                  type: "vowels",
                  clues: ["SL VS"],
                  answer: "SALVIUS",
                  explanation: "Well-known villain of CLC."
                },
                {
                  glyph: "lion",
                  code: "CLC 4",
                  title: "CLC IV characters",
                  type: "vowels",
                  clues: ["PLS PS TN"],
                  answer: "POLYSPASTON",
                  explanation: "Crane/hoist � a 'character' in the building site."
                },
                {
                  glyph: "flax",
                  code: "Quote 1",
                  title: "Famous Latin quote",
                  type: "vowels",
                  clues: ["VNV DVC"],
                  answer: "VENI, VIDI, VICI",
                  explanation: "Caesar's phrase."
                },
                {
                  glyph: "horned-viper",
                  code: "Quote 2",
                  title: "Famous Latin quote",
                  type: "vowels",
                  clues: ["CR PD M"],
                  answer: "CARPE DIEM",
                  explanation: "'Seize the day'."
                },
                {
                  glyph: "water",
                  code: "Quote 3",
                  title: "Famous Latin quote",
                  type: "vowels",
                  clues: ["TT BRT"],
                  answer: "ET TU, BRUTE?",
                  explanation: "Caesar to Brutus."
                },
                {
                  glyph: "eye",
                  code: "Quote 4",
                  title: "Famous Latin quote",
                  type: "vowels",
                  clues: ["L CT ST"],
                  answer: "ALEA IACTA EST",
                  explanation: "'The die is cast'."
                },
                {
                  glyph: "two-reeds",
                  code: "Antonyms 1",
                  title: "Latin antonyms",
                  type: "vowels",
                  clues: ["LX TNX"],
                  answer: "LUX ET NOX",
                  explanation: "Light and night."
                },
                {
                  glyph: "lion",
                  code: "Antonyms 2",
                  title: "Latin antonyms",
                  type: "vowels",
                  clues: ["LT STT RSTS"],
                  answer: "LAETUS ET TRISTIS",
                  explanation: "Happy and sad."
                },
                {
                  glyph: "flax",
                  code: "Antonyms 3",
                  title: "Latin antonyms",
                  type: "vowels",
                  clues: ["MGN STP RVS"],
                  answer: "MAGNUS ET PARVUS",
                  explanation: "Big and small."
                },
                {
                  glyph: "horned-viper",
                  code: "Antonyms 4",
                  title: "Latin antonyms",
                  type: "vowels",
                  clues: ["FRT STGN VS"],
                  answer: "FORTIS ET IGNAVUS",
                  explanation: "Brave and cowardly."
                }
              ]
            }
          }
        },
        {
          id: "4laa-only-connect",
          name: "4LAA � Only Connect",
          rounds: {
            connection: {
              label: "Round 1 � Connections",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "Outer letters",
                  title: "Outer letters of gods",
                  type: "connection",
                  clues: ["V-S", "M-A", "A-S", "J-R"],
                  answer: "Outer letters of Roman gods' names.",
                  explanation: "E.g. Venus, Mars, Ares, Jupiter etc."
                },
                {
                  glyph: "lion",
                  code: "Hills of Rome",
                  title: "Seven hills of Rome",
                  type: "connection",
                  clues: ["Viminal", "Esquiline", "Capitoline", "Palatine"],
                  answer: "Four of the seven hills of Rome.",
                  explanation: "Core topographical knowledge."
                },
                {
                  glyph: "flax",
                  code: "Farm animals",
                  title: "Farm animals in Latin",
                  type: "connection",
                  clues: ["gallus", "vacca", "porcus", "equus"],
                  answer: "Latin words for farm animals.",
                  explanation: "Same set as in other quizzes."
                },
                {
                  glyph: "horned-viper",
                  code: "Seven Wonders",
                  title: "Locations of Seven Wonders",
                  type: "connection",
                  clues: ["Halicarnassus", "Rhodes", "Alexandria", "Giza"],
                  answer: "Locations of the Seven Wonders.",
                  explanation: "Mausoleum, Colossus, Lighthouse, Pyramids."
                }
              ]
            },
            sequence: {
              label: "Round 2 � Sequences",
              questions: [
                {
                  glyph: "two-reeds",
                  code: "Deities A�D",
                  title: "Roman deities in alphabetical order",
                  type: "sequence",
                  clues: ["Apollo", "Bacchus", "Ceres"],
                  answer: "e.g. Diana (or Demeter, Dionysus)",
                  explanation: "Continuing the alphabetical list."
                },
                {
                  glyph: "lion",
                  code: "Emperors 3-letter",
                  title: "Emperors, first three letters",
                  type: "sequence",
                  clues: ["CLA", "GAI", "TIB"],
                  answer: "AUG",
                  explanation: "Claudius, Gaius, Tiberius, Augustus."
                },
                {
                  glyph: "flax",
                  code: "Aeneas",
                  title: "Journey of Aeneas",
                  type: "sequence",
                  clues: ["Troy", "Carthage", "Sicily"],
                  answer: "Italy",
                  explanation: "Aeneas' journey ends in Italy."
                },
                {
                  glyph: "horned-viper",
                  code: "Zeus' family",
                  title: "Lineage / descent of Zeus",
                  type: "sequence",
                  clues: ["Ga?a", "???a???", "??????"],
                  answer: "?e??",
                  explanation: "Gaia ? Ouranos ? Kronos ? Zeus."
                }
              ]
            },
            vowels: {
              label: "Round 3 � Missing vowels",
              questions: [
                {
                  glyph: "water",
                  code: "Gods 1",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["Z SN DJP TR"],
                  answer: "ZEUS AND JUPITER",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "eye",
                  code: "Gods 2",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["RSN DM RS"],
                  answer: "ARES AND MARS",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "two-reeds",
                  code: "Gods 3",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["P HRD TN DVNS"],
                  answer: "APHRODITE AND VENUS",
                  explanation: "Greek�Roman god pair."
                },
                {
                  glyph: "lion",
                  code: "Gods 4",
                  title: "Greek & Roman gods",
                  type: "vowels",
                  clues: ["PLL ND PLL"],
                  answer: "APOLLO AND APOLLO",
                  explanation: "Same name in Greek and Latin."
                },
                {
                  glyph: "flax",
                  code: "Verb 1",
                  title: "Latin verbs",
                  type: "vowels",
                  clues: ["MB LNT"],
                  answer: "AMBULANT",
                  explanation: "'They walk'."
                },
                {
                  glyph: "horned-viper",
                  code: "Verb 2",
                  title: "Latin verbs",
                  clues: ["HB"],
                  type: "vowels",
                  answer: "HABEO",
                  explanation: "'I have'."
                },
                {
                  glyph: "water",
                  code: "Verb 3",
                  title: "Latin verbs",
                  type: "vowels",
                  clues: ["DVRNT"],
                  answer: "AUDIVERUNT",
                  explanation: "'They heard'."
                },
                {
                  glyph: "eye",
                  code: "Verb 4",
                  title: "Latin verbs",
                  type: "vowels",
                  clues: ["DC"],
                  answer: "DICO / DUCO",
                  explanation: "Could be dico or duco."
                },
                {
                  glyph: "two-reeds",
                  code: "Letter 1",
                  title: "Greek letter names",
                  type: "vowels",
                  clues: ["LP H"],
                  answer: "ALPHA",
                  explanation: "First letter of Greek alphabet."
                },
                {
                  glyph: "lion",
                  code: "Letter 2",
                  title: "Greek letter names",
                  type: "vowels",
                  clues: ["G MM"],
                  answer: "GAMMA",
                  explanation: "Third letter of Greek alphabet."
                },
                {
                  glyph: "flax",
                  code: "Letter 3",
                  title: "Greek letter names",
                  type: "vowels",
                  clues: ["P S"],
                  answer: "PSI",
                  explanation: "Greek letter name."
                },
                {
                  glyph: "horned-viper",
                  code: "Letter 4",
                  title: "Greek letter names",
                  type: "vowels",
                  clues: ["PS LN"],
                  answer: "EPSILON / UPSILON",
                  explanation: "Ambiguous reconstruction: could be either."
                }
              ]
            }
          }
        },
        ],
        2023: [],
        2022: []
      }
    };

    // ----------------------------------------
    // STATE & HELPERS
    // ----------------------------------------

    let onStartPage = true; // Track if user is on start page
    let currentYear = null; // Selected year
    let currentYearGroupId = null; // Selected quiz within year
    let currentRoundKey = "connection";
    let currentQuestionIndex = null;
    let revealedClues = 0;
    let vowelsClueIndex = 0; // Tracks which clue (1-3) is showing within a vowels topic
    let usedQuestions = {
      connection: new Set(),
      sequence: new Set(),
      vowels: new Set()
    };

    // Timer configuration (in seconds) - now uses teacher settings
    let currentTimerDuration = 60; // Track which duration is active

    let timerInterval = null;
    let timerRunning = false;
    let timeRemaining = 0;

    // Team scoring state
    const SCORE_KEY = 'onlyconnect_scores';
    const SCORE_BREAKDOWN_KEY = 'onlyconnect_scores_breakdown';
    const teamScores = { team1: 0, team2: 0 };
    const teamScoresPerRound = {
      team1: { connection: 0, sequence: 0, vowels: 0 },
      team2: { connection: 0, sequence: 0, vowels: 0 }
    };
    let currentTeam = 'team1'; // which team is currently playing / buzzing

    const yearGroupSelect = document.getElementById("yearGroupSelect");
    const roundTabs = document.getElementById("roundTabs");
    const questionList = document.getElementById("questionList");
    const questionView = document.getElementById("questionView");
    const timerContainer = document.getElementById("timerContainer");
    const timerBar = document.getElementById("timerBar");
    const timerDisplay = document.getElementById("timerDisplay");
    const timerStartBtn = document.getElementById("timerStartBtn");
    const timerPauseBtn = document.getElementById("timerPauseBtn");
    const timerResetBtn = document.getElementById("timerResetBtn");
    const team1Btn = document.getElementById("team1Btn");
    const team2Btn = document.getElementById("team2Btn");
    const team1ScoreEl = document.getElementById("team1Score");
    const team2ScoreEl = document.getElementById("team2Score");
    const teamSetupBtn = document.getElementById("teamSetupBtn");
    const newGameBtn = document.getElementById("newGameBtn");
    const deleteQuizBtn = document.getElementById("deleteQuizBtn");
    const breadcrumbsPath = document.getElementById("breadcrumbsPath");
    const breadcrumbsControls = document.getElementById("breadcrumbsControls");
    const editorLoadSelect = document.getElementById("editorLoadSelect");
    const loadQuizBtn = document.getElementById("loadQuizBtn");
    const undoBtn = document.getElementById("undoBtn");
    const fullscreenBtn = document.getElementById("fullscreenBtn");

    // Sound effects
    const sounds = {
      correct: null,
      incorrect: null,
      timerWarning: null,
      timerEnd: null,
      pointAward: null
    };

    // Initialize audio context and create simple beep sounds
    function initSounds() {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;

      const ctx = new AudioContext();

      function createTone(frequency, duration, type = 'sine') {
        return function() {
          if (ctx.state === 'suspended') ctx.resume();
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);
          oscillator.frequency.value = frequency;
          oscillator.type = type;
          gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + duration);
        };
      }

      sounds.correct = () => {
        if (ctx.state === 'suspended') ctx.resume();
        // Happy ascending notes
        [523.25, 659.25, 783.99].forEach((freq, i) => {
          setTimeout(() => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = freq;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.2, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.15);
          }, i * 80);
        });
      };

      sounds.incorrect = () => {
        if (ctx.state === 'suspended') ctx.resume();
        // Descending notes
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(400, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.3);
        osc.type = 'sawtooth';
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      };

      sounds.timerWarning = createTone(800, 0.1, 'square');
      sounds.timerEnd = createTone(300, 0.5, 'sawtooth');
      sounds.pointAward = sounds.correct;
    }

    // Initialize sounds on first user interaction
    let soundsInitialized = false;
    document.addEventListener('click', () => {
      if (!soundsInitialized) {
        initSounds();
        soundsInitialized = true;
      }
    }, { once: true });

    // Undo stack for scoring actions
    const undoStack = [];
    const MAX_UNDO_STACK = 10;

    function pushUndoAction(action) {
      undoStack.push(action);
      if (undoStack.length > MAX_UNDO_STACK) {
        undoStack.shift();
      }
      if (undoBtn) undoBtn.disabled = false;
    }

    function performUndo() {
      if (undoStack.length === 0) return;
      const action = undoStack.pop();
      
      // Reverse the action
      if (action.type === 'award') {
        teamScores[action.team] -= action.points;
        if (action.round && teamScoresPerRound[action.team]) {
          teamScoresPerRound[action.team][action.round] -= action.points;
        }
      }
      
      saveScoresToStorage();
      updateScoreDisplay();
      
      if (undoStack.length === 0 && undoBtn) {
        undoBtn.disabled = true;
      }
      
      // Show feedback
      showPointAnimation('UNDO', '#fbbf24');
    }

    function upsertQuiz(year, quiz) {
      if (!quizData.years[year]) quizData.years[year] = [];
      const idx = quizData.years[year].findIndex(q => q.id === quiz.id);
      if (idx >= 0) {
        quizData.years[year][idx] = quiz;
      } else {
        quizData.years[year].push(quiz);
      }
    }

    function findYearForQuizId(quizId) {
      for (const yearKey of Object.keys(quizData.years)) {
        const quizzes = quizData.years[yearKey] || [];
        if (quizzes.some((q) => q.id === quizId)) {
          return parseInt(yearKey, 10);
        }
      }
      return null;
    }

    function getCurrentYearGroup() {
      // Ensure we have a year when a quiz id is selected (e.g., after page reloads)
      if (!currentYear && currentYearGroupId) {
        const foundYear = findYearForQuizId(currentYearGroupId);
        if (foundYear) currentYear = foundYear;
      }
      const quizzes = quizData.years[currentYear] || [];
      return quizzes.find((yg) => yg.id === currentYearGroupId) || null;
    }

    function getRound(roundKey) {
      const yg = getCurrentYearGroup();
      if (!yg) return null;
      return yg.rounds[roundKey] || null;
    }

    function getCurrentQuestion() {
      const round = getRound(currentRoundKey);
      if (!round) return null;
      return round.questions[currentQuestionIndex] || null;
    }

    function glyphSrc(glyph) {
      if (!glyph) return null;
      return `glyph-${glyph}.png`;
    }

    // ----------------------------------------
    // TIMER FUNCTIONS
    // ----------------------------------------

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateTimerDisplay() {
      const percentage = (timeRemaining / currentTimerDuration) * 100;

      timerDisplay.textContent = formatTime(timeRemaining);
      timerBar.style.width = percentage + '%';

      // Change color based on time remaining
      timerBar.classList.remove('warning', 'danger');
      if (percentage <= 20) {
        timerBar.classList.add('danger');
        // Play warning sound at 20%, 10%, and 5%
        if (timeRemaining === Math.floor(currentTimerDuration * 0.2) || 
            timeRemaining === Math.floor(currentTimerDuration * 0.1) || 
            timeRemaining === Math.floor(currentTimerDuration * 0.05)) {
          if (teacherSettings.soundsEnabled && sounds.timerWarning) sounds.timerWarning();
        }
      } else if (percentage <= 50) {
        timerBar.classList.add('warning');
      }
    }

    function startTimer() {
      if (timerRunning) return;

      timerRunning = true;
      timerStartBtn.style.display = 'none';
      timerPauseBtn.style.display = 'inline-block';

      timerInterval = setInterval(() => {
        timeRemaining--;

        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          timerRunning = false;
          timeRemaining = 0;
          timerStartBtn.style.display = 'inline-block';
          timerPauseBtn.style.display = 'none';
          // Play timer end sound
          if (teacherSettings.soundsEnabled && sounds.timerEnd) sounds.timerEnd();
        }

        updateTimerDisplay();
      }, 1000);
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      timerRunning = false;
      timerStartBtn.style.display = 'inline-block';
      timerPauseBtn.style.display = 'none';
    }

    function resetTimer() {
      clearInterval(timerInterval);
      timerRunning = false;
      timeRemaining = currentTimerDuration;
      timerStartBtn.style.display = 'inline-block';
      timerPauseBtn.style.display = 'none';
      updateTimerDisplay();
    }

    function startQuestionTimer() {
      currentTimerDuration = teacherSettings.standardTimer;
      resetTimer();
      timerContainer.classList.add('active');
      if (teacherSettings.autoStartTimer) {
        startTimer();
      }
    }

    function startQuestionTimer() {
      resetTimer();
      timerContainer.classList.add('active');
    }

    function startQuestionTimerAuto() {
      currentTimerDuration = teacherSettings.standardTimer;
      resetTimer();
      timerContainer.classList.add('active');
      if (teacherSettings.autoStartTimer) {
        startTimer();
      }
    }

    function startVowelsTimerAuto() {
      currentTimerDuration = teacherSettings.vowelsTimer;
      resetTimer();
      timerContainer.classList.add('active');
      if (teacherSettings.autoStartTimer) {
        startTimer();
      }
    }

    function hideQuestionTimer() {
      clearInterval(timerInterval);
      timerRunning = false;
      timerContainer.classList.remove('active');
      currentTimerDuration = teacherSettings.standardTimer;
    }

    function getQuizById(id) {
      let found = null;
      Object.keys(quizData.years || {}).forEach(year => {
        if (found) return;
        const hit = (quizData.years[year] || []).find(q => q.id === id);
        if (hit) found = { year: parseInt(year, 10), quiz: hit };
      });
      return found;
    }

    function populateEditorLoadSelect() {
      if (!editorLoadSelect) return;
      const options = [`<option value=\"\">-- Select quiz --</option>`];
      Object.keys(quizData.years || {}).sort((a, b) => b - a).forEach(year => {
        (quizData.years[year] || []).forEach(qz => {
          options.push(`<option value=\"${qz.id}\">${year} � ${qz.name}</option>`);
        });
      });
      editorLoadSelect.innerHTML = options.join('');
    }

    /* Team setup modal HTML (hidden by default) */
    (function insertTeamModal(){
      const html = `
      <div id="teamSetupModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:60;">
        <div style="width:520px;background:var(--tile);border:2px solid var(--tile-border);border-radius:12px;padding:1.2rem;color:var(--text-main);box-shadow:0 20px 50px rgba(0,0,0,0.8);">
          <h3 style="margin-bottom:0.6rem;color:var(--accent);">Team Setup</h3>
          <div style="display:flex;gap:1rem;margin-bottom:0.8rem;">
            <div style="flex:1;display:flex;flex-direction:column;gap:0.6rem;">
              <label style="font-size:0.85rem;color:var(--text-muted);">Team 1 name</label>
              <input id="teamName1" type="text" style="padding:0.5rem;border-radius:6px;border:1px solid var(--tile-border);background:transparent;color:var(--text-main);" />
              <div style="font-size:0.85rem;color:var(--text-muted);margin-top:0.5rem;">Score: <strong id="team1ScoreModal">0</strong></div>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;gap:0.6rem;">
              <label style="font-size:0.85rem;color:var(--text-muted);">Team 2 name</label>
              <input id="teamName2" type="text" style="padding:0.5rem;border-radius:6px;border:1px solid var(--tile-border);background:transparent;color:var(--text-main);" />
              <div style="font-size:0.85rem;color:var(--text-muted);margin-top:0.5rem;">Score: <strong id="team2ScoreModal">0</strong></div>
            </div>
          </div>
          <div id="teamBreakdown" style="margin-bottom:0.8rem;">&nbsp;</div>
          <div style="display:flex;justify-content:space-between;gap:0.6rem;">
            <div>
              <button class="btn-ghost" onclick="closeTeamSetup()">Cancel</button>
              <button class="btn-primary" onclick="saveTeamNames()">Save</button>
            </div>
            <div>
              <button class="btn-danger" onclick="resetScores()">Reset scores & breakdown</button>
            </div>
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
    })();

    /* Teacher Setup modal HTML (hidden by default) */
    (function insertTeacherSetupModal(){
      const html = `
      <div id="teacherSetupModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:70;">
        <div style="width:700px;max-width:95vw;background:var(--tile);border:2px solid var(--tile-border);border-radius:12px;padding:1.5rem;color:var(--text-main);box-shadow:0 20px 50px rgba(0,0,0,0.8);max-height:85vh;overflow-y:auto;">
          <h2 style="margin-bottom:1rem;color:var(--accent);font-size:1.2rem;">⚙️ Teacher Setup & Options</h2>
          
          <div style="display:flex;flex-direction:column;gap:1.5rem;">
            
            <!-- Sound Settings -->
            <div style="padding:1rem;background:rgba(30,41,59,0.5);border-radius:0.8rem;border:1px solid #334155;">
              <h3 style="font-size:0.9rem;color:var(--accent);margin-bottom:0.8rem;">🔊 Sound Settings</h3>
              <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                <input type="checkbox" id="setupEnableSounds" style="width:18px;height:18px;">
                <span style="font-size:0.85rem;">Enable sound effects (correct/incorrect/timer)</span>
              </label>
            </div>

            <!-- Timer Settings -->
            <div style="padding:1rem;background:rgba(30,41,59,0.5);border-radius:0.8rem;border:1px solid #334155;">
              <h3 style="font-size:0.9rem;color:var(--accent);margin-bottom:0.8rem;">⏱️ Timer Settings</h3>
              <div style="display:flex;flex-direction:column;gap:0.8rem;">
                <div>
                  <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem;">Connections & Sequences Timer (seconds)</label>
                  <input type="number" id="setupStandardTimer" value="60" min="10" max="300" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
                </div>
                <div>
                  <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem;">Missing Vowels Timer (seconds)</label>
                  <input type="number" id="setupVowelsTimer" value="180" min="30" max="600" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
                </div>
                <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                  <input type="checkbox" id="setupAutoStartTimer" style="width:18px;height:18px;">
                  <span style="font-size:0.85rem;">Auto-start timer when question opens</span>
                </label>
              </div>
            </div>

            <!-- Scoring Settings -->
            <div style="padding:1rem;background:rgba(30,41,59,0.5);border-radius:0.8rem;border:1px solid #334155;">
              <h3 style="font-size:0.9rem;color:var(--accent);margin-bottom:0.8rem;">🏆 Scoring Settings</h3>
              <div style="display:flex;flex-direction:column;gap:0.8rem;">
                <div>
                  <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem;">Points for 1st clue</label>
                  <input type="number" id="setupPoints1" value="5" min="1" max="10" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
                </div>
                <div>
                  <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem;">Points for 2nd clue</label>
                  <input type="number" id="setupPoints2" value="3" min="1" max="10" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
                </div>
                <div>
                  <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem;">Points for 3rd clue</label>
                  <input type="number" id="setupPoints3" value="2" min="1" max="10" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
                </div>
                <div>
                  <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem;">Points for 4th clue</label>
                  <input type="number" id="setupPoints4" value="1" min="1" max="10" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
                </div>
              </div>
            </div>

            <!-- Display Settings -->
            <div style="padding:1rem;background:rgba(30,41,59,0.5);border-radius:0.8rem;border:1px solid #334155;">
              <h3 style="font-size:0.9rem;color:var(--accent);margin-bottom:0.8rem;">🎨 Display Settings</h3>
              <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;margin-bottom:0.8rem;">
                <input type="checkbox" id="setupShowExplanations" style="width:18px;height:18px;" checked>
                <span style="font-size:0.85rem;">Show explanations with answers</span>
              </label>
              <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                <input type="checkbox" id="setupShowProgress" style="width:18px;height:18px;" checked>
                <span style="font-size:0.85rem;">Show progress indicators on completed questions</span>
              </label>
            </div>

            <!-- Data Management -->
            <div style="padding:1rem;background:rgba(30,41,59,0.5);border-radius:0.8rem;border:1px solid #334155;">
              <h3 style="font-size:0.9rem;color:var(--accent);margin-bottom:0.8rem;">💾 Data Management</h3>
              <div style="display:flex;flex-direction:column;gap:0.6rem;">
                <button class="btn-secondary" onclick="teacherSetup.exportAllData()" style="text-align:left;padding:0.5rem 0.8rem;">📥 Export All Quizzes (JSON)</button>
                <button class="btn-secondary" onclick="teacherSetup.importData()" style="text-align:left;padding:0.5rem 0.8rem;">📤 Import Quizzes (JSON)</button>
                <button class="btn-danger" onclick="teacherSetup.clearAllData()" style="text-align:left;padding:0.5rem 0.8rem;">🗑️ Clear All Data (Reset App)</button>
              </div>
            </div>

          </div>

          <div style="display:flex;justify-content:space-between;gap:0.6rem;margin-top:1.5rem;">
            <button class="btn-ghost" onclick="closeTeacherSetup()">Cancel</button>
            <button class="btn-primary" onclick="saveTeacherSetup()">Save Settings</button>
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
    })();

    // ----------------------------------------
    // SCORING / TEAM HELPERS
    // ----------------------------------------

    function saveScoresToStorage() {
      try {
        localStorage.setItem(SCORE_KEY, JSON.stringify(teamScores));
        localStorage.setItem(SCORE_BREAKDOWN_KEY, JSON.stringify(teamScoresPerRound));
      } catch (e) { /* ignore */ }
    }

    function loadScoresFromStorage() {
      try {
        const s = localStorage.getItem(SCORE_KEY);
        const b = localStorage.getItem(SCORE_BREAKDOWN_KEY);
        if (s) {
          const parsed = JSON.parse(s);
          if (typeof parsed.team1 === 'number') teamScores.team1 = parsed.team1;
          if (typeof parsed.team2 === 'number') teamScores.team2 = parsed.team2;
        }
        if (b) {
          const parsed = JSON.parse(b);
          if (parsed.team1) teamScoresPerRound.team1 = parsed.team1;
          if (parsed.team2) teamScoresPerRound.team2 = parsed.team2;
        }
      } catch (e) { /* ignore */ }
    }

    function updateScoreDisplay() {
      team1ScoreEl.textContent = teamScores.team1;
      team2ScoreEl.textContent = teamScores.team2;
      const t1Modal = document.getElementById('team1ScoreModal');
      const t2Modal = document.getElementById('team2ScoreModal');
      if (t1Modal) t1Modal.textContent = teamScores.team1;
      if (t2Modal) t2Modal.textContent = teamScores.team2;
      // refresh button labels in case names changed
      if (teamNames?.team1) team1Btn.textContent = teamNames.team1;
      if (teamNames?.team2) team2Btn.textContent = teamNames.team2;
      // highlight active team button
      if (currentTeam === 'team1') {
        team1Btn.classList.add('active');
        team2Btn.classList.remove('active');
      } else {
        team2Btn.classList.add('active');
        team1Btn.classList.remove('active');
      }

      // If modal is open, refresh breakdown display
      const bd = document.getElementById('teamBreakdown');
      if (bd) {
        bd.innerHTML = `\n          <div style="display:flex;gap:1rem;">\n            <div style="flex:1">\n              <strong>${teamNames.team1}</strong>\n              <div style="font-size:0.85rem;color:var(--text-muted)">\n                Connections: ${teamScoresPerRound.team1.connection}<br>\n                Sequences: ${teamScoresPerRound.team1.sequence}<br>\n                Vowels: ${teamScoresPerRound.team1.vowels}\n              </div>\n            </div>\n            <div style="flex:1">\n              <strong>${teamNames.team2}</strong>\n              <div style="font-size:0.85rem;color:var(--text-muted)">\n                Connections: ${teamScoresPerRound.team2.connection}<br>\n                Sequences: ${teamScoresPerRound.team2.sequence}<br>\n                Vowels: ${teamScoresPerRound.team2.vowels}\n              </div>\n            </div>\n          </div>`;
      }
    }

    function awardPoints(teamKey, points, roundKey = currentRoundKey) {
      if (!['team1','team2'].includes(teamKey)) return;
      
      // Push to undo stack before making changes
      pushUndoAction({
        type: 'award',
        team: teamKey,
        points: points,
        round: roundKey
      });
      
      teamScores[teamKey] += points;
      // Update per-round breakdown if applicable
      if (roundKey && teamScoresPerRound[teamKey] && typeof teamScoresPerRound[teamKey][roundKey] === 'number') {
        teamScoresPerRound[teamKey][roundKey] += points;
      }
      saveScoresToStorage();
      updateScoreDisplay();
      
      // Play sound and show animation
      if (teacherSettings.soundsEnabled && sounds.pointAward) sounds.pointAward();
      showPointAnimation(`+${points}`, '#38bdf8');
    }

    function awardOpponentBonus(points = 1) {
      const opp = currentTeam === 'team1' ? 'team2' : 'team1';
      awardPoints(opp, points);
    }

    function setCurrentTeam(teamKey) {
      if (!['team1','team2'].includes(teamKey)) return;
      currentTeam = teamKey;
      updateScoreDisplay();
    }

    function advanceTeamTurn() {
      currentTeam = currentTeam === 'team1' ? 'team2' : 'team1';
      updateScoreDisplay();
    }

    // Load / persist team names
    const TEAM_NAMES_KEY = 'onlyconnect_teamNames';
    let teamNames = { team1: 'Team 1', team2: 'Team 2' };
    try {
      const savedNames = localStorage.getItem(TEAM_NAMES_KEY);
      if (savedNames) teamNames = JSON.parse(savedNames);
    } catch (e) { /* ignore */ }

    function openTeamSetup() {
      const modal = document.getElementById('teamSetupModal');
      if (!modal) return;
      modal.style.display = 'flex';
      document.getElementById('teamName1').value = teamNames.team1;
      document.getElementById('teamName2').value = teamNames.team2;
    }

    function closeTeamSetup() {
      const modal = document.getElementById('teamSetupModal');
      if (!modal) return;
      modal.style.display = 'none';
    }

    function saveTeamNames() {
      const n1 = document.getElementById('teamName1').value.trim() || 'Team 1';
      const n2 = document.getElementById('teamName2').value.trim() || 'Team 2';
      teamNames.team1 = n1; teamNames.team2 = n2;
      try { localStorage.setItem(TEAM_NAMES_KEY, JSON.stringify(teamNames)); } catch(e){}
      updateScoreDisplay();
      closeTeamSetup();
    }

    function resetScores() {
      if (!confirm('Reset both teams\' scores and per-round breakdown?')) return;
      teamScores.team1 = 0; teamScores.team2 = 0;
      teamScoresPerRound.team1 = { connection: 0, sequence: 0, vowels: 0 };
      teamScoresPerRound.team2 = { connection: 0, sequence: 0, vowels: 0 };
      saveScoresToStorage();
      updateScoreDisplay();
    }

    // ----------------------------------------
    // TEACHER SETUP
    // ----------------------------------------

    const SETTINGS_KEY = 'teacherSettings';
    let teacherSettings = {
      soundsEnabled: true,
      standardTimer: 60,
      vowelsTimer: 180,
      autoStartTimer: true,
      points: [5, 3, 2, 1],
      showExplanations: true,
      showProgress: true
    };

    function loadTeacherSettings() {
      try {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) {
          teacherSettings = { ...teacherSettings, ...JSON.parse(saved) };
        }
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }

    function saveTeacherSettingsToStorage() {
      try {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(teacherSettings));
      } catch (e) {
        console.error('Failed to save settings:', e);
      }
    }

    function showTeacherSetup() {
      const modal = document.getElementById('teacherSetupModal');
      if (!modal) return;
      modal.style.display = 'flex';
      
      // Populate current settings
      document.getElementById('setupEnableSounds').checked = teacherSettings.soundsEnabled;
      document.getElementById('setupStandardTimer').value = teacherSettings.standardTimer;
      document.getElementById('setupVowelsTimer').value = teacherSettings.vowelsTimer;
      document.getElementById('setupAutoStartTimer').checked = teacherSettings.autoStartTimer;
      document.getElementById('setupPoints1').value = teacherSettings.points[0];
      document.getElementById('setupPoints2').value = teacherSettings.points[1];
      document.getElementById('setupPoints3').value = teacherSettings.points[2];
      document.getElementById('setupPoints4').value = teacherSettings.points[3];
      document.getElementById('setupShowExplanations').checked = teacherSettings.showExplanations;
      document.getElementById('setupShowProgress').checked = teacherSettings.showProgress;
    }

    function closeTeacherSetup() {
      const modal = document.getElementById('teacherSetupModal');
      if (!modal) return;
      modal.style.display = 'none';
    }

    function showHelpGuide() {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:200;overflow:auto;padding:2rem;';
      modal.innerHTML = `
        <div style="background:#020617;border:1px solid #1e293b;border-radius:1rem;padding:2rem;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
            <h2 style="color:var(--accent);font-size:1.5rem;margin:0;">📖 CONIUNGITE Teacher's Guide</h2>
            <button class="btn-ghost" onclick="this.closest('div[style*=fixed]').remove()" style="font-size:1.5rem;padding:0.25rem 0.75rem;">×</button>
          </div>
          
          <div style="color:var(--text-main);line-height:1.6;">
            
            <section style="margin-bottom:2rem;">
              <h3 style="color:var(--accent);font-size:1.2rem;margin-bottom:0.75rem;border-bottom:2px solid var(--accent);padding-bottom:0.5rem;">🎮 Getting Started</h3>
              <p style="margin-bottom:0.75rem;"><strong>CONIUNGITE</strong> is a Latin quiz game inspired by BBC's "Only Connect", featuring three challenging rounds: Connections, Sequences, and Missing Vowels.</p>
              
              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Playing a Quiz:</h4>
              <ol style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li>Click <strong>▶️ Play</strong> from the home page</li>
                <li>Select a year (e.g., 2025, 2024)</li>
                <li>Choose a quiz from the available options</li>
                <li>Set team names (or skip to use defaults)</li>
                <li>Click <strong>Start Quiz</strong> on the title screen</li>
              </ol>
            </section>

            <section style="margin-bottom:2rem;">
              <h3 style="color:var(--accent);font-size:1.2rem;margin-bottom:0.75rem;border-bottom:2px solid var(--accent);padding-bottom:0.5rem;">🎯 Game Rounds</h3>
              
              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Round 1: Connections</h4>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Objective:</strong> Find the connection between 4 clues</li>
                <li><strong>Scoring:</strong> 5 points (1 clue), 3 points (2 clues), 2 points (3 clues), 1 point (4 clues)</li>
                <li><strong>How to play:</strong> Click a hieroglyph to select a question, then reveal clues one at a time</li>
                <li><strong>Tip:</strong> Award points when the team gives the correct connection</li>
              </ul>

              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Round 2: Sequences</h4>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Objective:</strong> Identify what comes 4th in a sequence</li>
                <li><strong>Scoring:</strong> 5 points (2 clues), 3 points (3 clues), 2 points (4 clues)</li>
                <li><strong>How to play:</strong> Reveal clues in order; teams guess the next item</li>
                <li><strong>Example:</strong> I, V, X... → (Answer: L - Roman numerals)</li>
              </ul>

              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Round 3: Missing Vowels</h4>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Objective:</strong> Identify Latin words/phrases with vowels removed</li>
                <li><strong>Scoring:</strong> 1 point per correct answer</li>
                <li><strong>How to play:</strong> Click each clue to reveal; award points when answered correctly</li>
                <li><strong>Example:</strong> CCR → CICERO</li>
                <li><strong>Tip:</strong> This round is fast-paced - teams can buzz in as soon as they know!</li>
              </ul>
            </section>

            <section style="margin-bottom:2rem;">
              <h3 style="color:var(--accent);font-size:1.2rem;margin-bottom:0.75rem;border-bottom:2px solid var(--accent);padding-bottom:0.5rem;">🎨 Creating Custom Quizzes</h3>
              
              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Starting a New Quiz:</h4>
              <ol style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li>Click <strong>✏️ Create</strong> in the header</li>
                <li>Enter a quiz name (e.g., "U5 Christmas Quiz 2025")</li>
                <li>Select a year to organize your quiz</li>
                <li>Click <strong>Start Creating</strong></li>
              </ol>

              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Adding Questions:</h4>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Auto-generate:</strong> Click "+ Add 6 Questions" to create templates</li>
                <li><strong>Manual:</strong> Fill in question title, clues (one per line), and answer</li>
                <li><strong>Images:</strong> Paste images directly into clue fields (Ctrl+V)</li>
                <li><strong>Reorder:</strong> Drag questions using the ⋮⋮ handle (especially useful for vowels round)</li>
                <li><strong>Duplicate:</strong> Copy existing questions to save time</li>
                <li><strong>Reuse:</strong> Import questions from other quizzes</li>
              </ul>

              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Saving Your Work:</h4>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Save:</strong> Stores quiz to browser localStorage</li>
                <li><strong>Save & Play:</strong> Saves and immediately starts the quiz</li>
                <li><strong>Note:</strong> Quizzes with many images may exceed storage - you'll see a warning but can still play in-memory</li>
              </ul>
            </section>

            <section style="margin-bottom:2rem;">
              <h3 style="color:var(--accent);font-size:1.2rem;margin-bottom:0.75rem;border-bottom:2px solid var(--accent);padding-bottom:0.5rem;">⚙️ Settings & Features</h3>
              
              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Teacher Setup (⚙️ Setup button):</h4>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Sounds:</strong> Enable/disable sound effects</li>
                <li><strong>Timers:</strong> Customize time limits for each round</li>
                <li><strong>Auto-start Timer:</strong> Timer starts automatically when question opens</li>
                <li><strong>Points:</strong> Adjust point values for different clue reveals</li>
                <li><strong>Display:</strong> Toggle animations and celebrations</li>
                <li><strong>Data Management:</strong> Export quizzes (JSON), import from file, or clear all data</li>
              </ul>

              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">During Gameplay:</h4>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Team Setup:</strong> Edit team names or reset scores mid-game</li>
                <li><strong>Undo:</strong> Reverse the last 10 scoring actions</li>
                <li><strong>End Quiz:</strong> Return to home page and show final scores</li>
                <li><strong>Fullscreen:</strong> Use the button (bottom-right) for immersive display</li>
              </ul>

              <h4 style="color:#60a5fa;margin-top:1rem;margin-bottom:0.5rem;">Keyboard Shortcuts:</h4>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Space:</strong> Reveal next clue / advance</li>
                <li><strong>1 or 2:</strong> Award points to Team 1 or Team 2</li>
                <li><strong>T:</strong> Start/stop timer</li>
                <li><strong>Enter:</strong> Toggle answer display</li>
                <li><strong>Backspace:</strong> Go back / close question</li>
                <li><strong>X:</strong> Mark incorrect (reveals remaining clues)</li>
              </ul>
            </section>

            <section style="margin-bottom:2rem;">
              <h3 style="color:var(--accent);font-size:1.2rem;margin-bottom:0.75rem;border-bottom:2px solid var(--accent);padding-bottom:0.5rem;">💡 Tips & Best Practices</h3>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Test before class:</strong> Play through your quiz to check all questions work</li>
                <li><strong>Balance difficulty:</strong> Mix easy and hard questions to keep all students engaged</li>
                <li><strong>Use images:</strong> Visual clues make the game more engaging (paste directly with Ctrl+V)</li>
                <li><strong>Organize vowels:</strong> Group Missing Vowels questions by theme using drag-and-drop</li>
                <li><strong>Save regularly:</strong> Click Save while creating to avoid losing work</li>
                <li><strong>Export backups:</strong> Use Setup → Data Management → Export to save quiz files</li>
                <li><strong>State persistence:</strong> Page refreshes will return you to where you were (lasts 1 hour)</li>
                <li><strong>Projector mode:</strong> Use fullscreen for classroom projection</li>
              </ul>
            </section>

            <section style="margin-bottom:2rem;">
              <h3 style="color:var(--accent);font-size:1.2rem;margin-bottom:0.75rem;border-bottom:2px solid var(--accent);padding-bottom:0.5rem;">🔧 Troubleshooting</h3>
              <ul style="margin-left:1.5rem;margin-bottom:0.75rem;">
                <li><strong>Quiz won't load:</strong> Check browser console (F12) for errors; quiz may have been deleted</li>
                <li><strong>Storage warning:</strong> Too many large images - quiz still works but won't save to localStorage</li>
                <li><strong>Lost quiz:</strong> If not saved, quizzes are lost on page close - always click Save!</li>
                <li><strong>Wrong score:</strong> Use the Undo button (supports last 10 actions)</li>
                <li><strong>Stuck on page:</strong> Click "End Quiz" or refresh browser to restart</li>
              </ul>
            </section>

            <section>
              <h3 style="color:var(--accent);font-size:1.2rem;margin-bottom:0.75rem;border-bottom:2px solid var(--accent);padding-bottom:0.5rem;">📚 Latin Quiz Ideas</h3>
              <ul style="margin-left:1.5rem;">
                <li><strong>Grammar Connections:</strong> Cases, tenses, verb forms that share properties</li>
                <li><strong>Mythology Sequences:</strong> Gods in family order, labors of Hercules, etc.</li>
                <li><strong>Vocabulary Themes:</strong> Words related to war, government, family</li>
                <li><strong>Historical Timelines:</strong> Roman emperors, events in chronological order</li>
                <li><strong>Literary Connections:</strong> Authors, characters, famous quotes</li>
                <li><strong>Vowels Round:</strong> Latin phrases, famous Romans, mythology names</li>
              </ul>
            </section>

            <div style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--text-muted);text-align:center;color:var(--text-muted);font-size:0.9rem;">
              <p>Have fun with CONIUNGITE! 🎓 Remember: It's not just about the points, it's about learning Latin in an engaging way.</p>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    function saveTeacherSetup() {
      teacherSettings.soundsEnabled = document.getElementById('setupEnableSounds').checked;
      teacherSettings.standardTimer = parseInt(document.getElementById('setupStandardTimer').value) || 60;
      teacherSettings.vowelsTimer = parseInt(document.getElementById('setupVowelsTimer').value) || 180;
      teacherSettings.autoStartTimer = document.getElementById('setupAutoStartTimer').checked;
      teacherSettings.points = [
        parseInt(document.getElementById('setupPoints1').value) || 5,
        parseInt(document.getElementById('setupPoints2').value) || 3,
        parseInt(document.getElementById('setupPoints3').value) || 2,
        parseInt(document.getElementById('setupPoints4').value) || 1
      ];
      teacherSettings.showExplanations = document.getElementById('setupShowExplanations').checked;
      teacherSettings.showProgress = document.getElementById('setupShowProgress').checked;
      
      saveTeacherSettingsToStorage();
      closeTeacherSetup();
      alert('Settings saved!');
    }

    const teacherSetup = {
      exportAllData() {
        const exportData = {
          quizzes: quizData.years,
          settings: teacherSettings,
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `coniungite-data-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
      },

      importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              
              if (data.quizzes) {
                Object.keys(data.quizzes).forEach(year => {
                  data.quizzes[year].forEach(quiz => {
                    upsertQuiz(parseInt(year), quiz);
                  });
                });
                localStorage.setItem('customQuizzes', JSON.stringify(quizData.years));
              }
              
              if (data.settings) {
                teacherSettings = { ...teacherSettings, ...data.settings };
                saveTeacherSettingsToStorage();
              }
              
              alert('Data imported successfully!');
              populateEditorLoadSelect();
            } catch (err) {
              alert('Error importing data: ' + err.message);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      },

      clearAllData() {
        // Password protection for dangerous operation
        const password = prompt('Enter admin password to clear all data:');
        if (password !== 'ALVK') {
          if (password !== null) alert('Incorrect password. Operation cancelled.');
          return;
        }
        
        if (!confirm('⚠️ WARNING: This will delete ALL quizzes, scores, and settings. This cannot be undone. Are you sure?')) return;
        if (!confirm('Really sure? Type YES in the next dialog to confirm.')) return;
        
        const confirm2 = prompt('Type YES in capital letters to confirm deletion:');
        if (confirm2 !== 'YES') {
          alert('Cancelled.');
          return;
        }
        
        localStorage.clear();
        alert('All data cleared. Page will reload.');
        location.reload();
      }
    };

    // Load settings on startup
    loadTeacherSettings();

    // ----------------------------------------
    // RENDERING
    // ----------------------------------------

    function renderYearGroupSelect() {
      yearGroupSelect.innerHTML = "";
      const quizzes = quizData.years[currentYear] || [];
      quizzes.forEach((yg) => {
        const opt = document.createElement("option");
        opt.value = yg.id;
        opt.textContent = yg.name;
        yearGroupSelect.appendChild(opt);
      });
      if (currentYearGroupId) {
        yearGroupSelect.value = currentYearGroupId;
      }
    }

    function renderRoundTabs() {
      const yg = getCurrentYearGroup();
      roundTabs.innerHTML = "";
      if (!yg || onStartPage) {
        roundTabs.style.display = "none";
        return;
      }
      roundTabs.style.display = "flex";

      const latinLabels = {
        connection: "Round 1 � Connectiones",
        sequence: "Round 2 � Quid Sequitur?",
        vowels: "Round 3 � Vocalibus Desunt"
      };

      const roundKeys = [
        { key: "connection", label: latinLabels.connection },
        { key: "sequence", label: latinLabels.sequence },
        { key: "vowels", label: latinLabels.vowels },
      ];

      roundKeys.forEach(({ key, label }) => {
        if (!yg.rounds[key]) return;
        const btn = document.createElement("button");
        btn.className = "round-tab" + (key === currentRoundKey ? " active" : "");
        btn.textContent = label;
        btn.addEventListener("click", () => {
          currentRoundKey = key;
          currentQuestionIndex = null;
          revealedClues = 0;
          vowelsClueIndex = 0;
          hideQuestionTimer();
          renderAll();
        });
        roundTabs.appendChild(btn);
      });
    }

    function renderBreadcrumbs() {
      const yg = getCurrentYearGroup();
      const round = getRound(currentRoundKey);
      const q = getCurrentQuestion();
      const parts = [];

      const latinLabels = {
        connection: "Round 1 � Connectiones",
        sequence: "Round 2 � Quid Sequitur?",
        vowels: "Round 3 � Vocalibus Desunt"
      };

      if (yg) parts.push(yg.name);
      if (round) parts.push(latinLabels[currentRoundKey] || round.label);
      if (q && currentQuestionIndex !== null) parts.push(`Question ${currentQuestionIndex + 1}`);

      breadcrumbsPath.innerHTML = "";
      if (onStartPage || !yg) {
        breadcrumbsPath.innerHTML = "";
      } else {
        parts.forEach((p) => {
          const span = document.createElement("span");
          span.textContent = p;
          breadcrumbsPath.appendChild(span);
        });
      }

      breadcrumbsControls.innerHTML = "";
      if (currentQuestionIndex !== null) {
        const backBtn = document.createElement("button");
        backBtn.className = "btn-ghost";
        backBtn.textContent = "Back to board";
        backBtn.addEventListener("click", () => {
          currentQuestionIndex = null;
          revealedClues = 0;
          renderAll();
        });
        breadcrumbsControls.appendChild(backBtn);
      }
    }

    function renderQuestionBoard() {
      const round = getRound(currentRoundKey);
      questionView.classList.remove("active");
      questionList.style.display = "grid";

      if (!round || !round.questions?.length) {
        questionList.innerHTML = "<p>No questions added yet for this round.</p>";
        return;
      }

      questionList.innerHTML = "";

      // For vowels round, show start screen
      if (currentRoundKey === "vowels") {
        const startCard = document.createElement("div");
        startCard.style.cssText = `
          grid-column: 1 / -1;
          padding: 2rem;
          background: radial-gradient(circle at 20% 0%, #1d2a3b, #020617 60%);
          border: 2px solid var(--tile-border);
          border-radius: 1.4rem;
          box-shadow: 0 24px 60px rgba(0, 0, 0, 0.9), 0 0 0 2px rgba(15, 23, 42, 0.9);
          text-align: center;
        `;

        const title = document.createElement("h2");
        title.style.cssText = `
          color: var(--accent);
          font-size: 1.2rem;
          text-transform: uppercase;
          letter-spacing: 0.16em;
          margin-bottom: 1rem;
        `;
        title.textContent = round.label;
        startCard.appendChild(title);

        const subtitle = document.createElement("p");
        subtitle.style.cssText = `
          color: var(--text-muted);
          margin-bottom: 2rem;
          font-size: 0.9rem;
        `;
        subtitle.textContent = `${round.questions.length} theme${round.questions.length > 1 ? 's' : ''} to discover`;
        startCard.appendChild(subtitle);

        const startBtn = document.createElement("button");
        startBtn.className = "btn-primary";
        startBtn.textContent = "Start";
        startBtn.style.cssText = `
          padding: 0.8rem 2rem;
          font-size: 0.9rem;
        `;
        startBtn.addEventListener("click", () => {
          currentQuestionIndex = 0;
          revealedClues = 0;
          vowelsClueIndex = 0;
          startVowelsTimerAuto();
          renderAll();
        });
        startCard.appendChild(startBtn);

        questionList.appendChild(startCard);
        return;
      }

      // For other rounds, show individual tiles
      round.questions.forEach((q, idx) => {
        const card = document.createElement("button");
        const isUsed = usedQuestions[currentRoundKey]?.has(idx);
        card.className = "glyph-card" + (isUsed ? " used" : "");
        if (isUsed) card.disabled = true;
        
        // Add progress indicator for attempted questions
        if (isUsed && teacherSettings.showProgress) {
          const indicator = document.createElement("div");
          indicator.className = "progress-indicator";
          card.appendChild(indicator);
        }
        
        card.addEventListener("click", () => {
          if (!usedQuestions[currentRoundKey]) usedQuestions[currentRoundKey] = new Set();
          usedQuestions[currentRoundKey].add(idx);
          currentQuestionIndex = idx;
          revealedClues = 0;
          startQuestionTimerAuto();
          renderAll();
        });

        const inner = document.createElement("div");
        inner.className = "glyph-inner";

        const src = glyphSrc(q.glyph);
        if (src) {
          const img = document.createElement("img");
          img.src = src;
          img.alt = q.code || "Question";
          inner.appendChild(img);
        } else {
          const fb = document.createElement("div");
          fb.className = "glyph-fallback";
          fb.textContent = (q.code || "Q").slice(0, 3).toUpperCase();
          inner.appendChild(fb);
        }

        const srOnly = document.createElement("span");
        srOnly.className = "visually-hidden";
        srOnly.textContent = q.title || "Question";
        inner.appendChild(srOnly);

        card.appendChild(inner);
        questionList.appendChild(card);
      });

      showRoundSummary(currentRoundKey);
    }

    // Helper function to render clue content (text and/or images)
    function renderClueContent(target, clue, hidden = false) {
      target.innerHTML = "";
      if (hidden) {
        target.textContent = "Hidden";
        return;
      }
      const isObj = clue && typeof clue === "object" && !Array.isArray(clue);
      let text = isObj ? clue.text : clue;
      let img = isObj ? clue.img : null;

      // Allow simple string syntax: "img:URL|alt text" or bare image URL
      if (!isObj && typeof clue === "string") {
        const maybe = clue.split("|");
        const raw = maybe[0].trim();
        const altFrom = maybe[1] ? maybe[1].trim() : "";
        const isImg = raw.startsWith("img:") || /\.(png|jpe?g|gif|webp|svg)$/i.test(raw);
        if (isImg) {
          img = raw.replace(/^img:/i, "");
          text = altFrom || "";
        }
      }

      if (text) {
        const span = document.createElement("div");
        span.textContent = text;
        target.appendChild(span);
      }
      if (img) {
        const imageEl = document.createElement("img");
        imageEl.src = img;
        imageEl.alt = text || "Clue image";
        imageEl.style.width = "100%";
        imageEl.style.height = "auto";
        imageEl.style.maxHeight = "300px";
        imageEl.style.objectFit = "contain";
        imageEl.style.borderRadius = "0.4rem";
        imageEl.style.marginTop = text ? "0.5rem" : "0";
        imageEl.style.display = "block";
        target.appendChild(imageEl);
      }
      if (!text && !img) {
        target.textContent = "";
      }
    }

    function renderQuestionView() {
      const q = getCurrentQuestion();
      if (!q) return;

      questionList.style.display = "none";
      questionView.classList.add("question-mode");
      questionView.classList.remove("start-mode");
      questionView.classList.add("active");

      // Special handling for vowels round
      if (currentRoundKey === "vowels") {
        renderVowelsQuestion();
        return;
      }

      const maxClues = q.clues?.length || 0;
      const safeRevealed = Math.min(revealedClues || 1, maxClues);

      const wrapper = document.createElement("div");
      wrapper.className = "clue-panel";

      const clueGrid = document.createElement("div");
      clueGrid.className = "clue-grid";

      for (let i = 0; i < maxClues; i++) {
        const revealed = i < safeRevealed;
        const card = document.createElement("div");
        card.className = "clue-card" + (revealed ? "" : " hidden");

        const label = document.createElement("div");
        label.className = "clue-label";
        label.textContent = q.type === "sequence" ? `Item ${i + 1}` : `Clue ${i + 1}`;

        const text = document.createElement("div");
        text.className = "clue-text";
        renderClueContent(text, q.clues[i], !revealed);

        card.appendChild(label);
        card.appendChild(text);
        clueGrid.appendChild(card);
      }

      wrapper.appendChild(clueGrid);

      const controlsRow = document.createElement("div");
      controlsRow.className = "controls-row";

      const leftGroup = document.createElement("div");
      leftGroup.className = "btn-group";

      const revealBtn = document.createElement("button");
      revealBtn.className = "btn-ghost";
      revealBtn.textContent = safeRevealed >= maxClues ? "All clues shown" : "Reveal next";
      revealBtn.disabled = safeRevealed >= maxClues;
      revealBtn.addEventListener("click", () => {
        revealedClues = Math.min(maxClues, safeRevealed + 1);
        renderAll();
      });
      leftGroup.appendChild(revealBtn);

      const resetBtn = document.createElement("button");
      resetBtn.className = "btn-ghost";
      resetBtn.textContent = "Hide clues";
      resetBtn.addEventListener("click", () => {
        revealedClues = 0;
        q._showAnswer = false;
        renderAll();
      });
      leftGroup.appendChild(resetBtn);

      controlsRow.appendChild(leftGroup);

      // Right-side controls: scoring and answer reveal
      const rightGroup = document.createElement("div");
      rightGroup.className = "btn-group";

      const pointsByClue = [5, 3, 2, 1];
      const possiblePoints = pointsByClue[Math.max(0, Math.min(3, safeRevealed - 1))] || 1;

      const possiblePointsActual = teacherSettings.points[Math.max(0, Math.min(3, safeRevealed - 1))] || possiblePoints;
      
      const correctBtn = document.createElement("button");
      correctBtn.className = "btn-accent";
      correctBtn.textContent = `Correct (+${possiblePointsActual})`;
      correctBtn.addEventListener("click", () => {
        awardPoints(currentTeam, possiblePointsActual);
        advanceTeamTurn();
        q._showAnswer = true;
        hideQuestionTimer();
        renderAll();
      });
      rightGroup.appendChild(correctBtn);

      const incorrectBtn = document.createElement("button");
      incorrectBtn.className = "btn-ghost";
      incorrectBtn.textContent = "Incorrect";
      incorrectBtn.addEventListener("click", () => {
        // Play incorrect sound
        if (teacherSettings.soundsEnabled && sounds.incorrect) sounds.incorrect();
        // Reveal remaining clues so the opposing team can see and try for the bonus
        revealedClues = Math.max(revealedClues || 1, maxClues);
        renderAll();
      });
      rightGroup.appendChild(incorrectBtn);

      const oppBtn = document.createElement("button");
      oppBtn.className = "btn-ghost";
      oppBtn.textContent = "Give opponent +1";
      oppBtn.addEventListener("click", () => {
        awardOpponentBonus(1);
      });
      rightGroup.appendChild(oppBtn);

      const answerBtn = document.createElement("button");
      answerBtn.className = "btn-accent";
      answerBtn.textContent = q._showAnswer ? "Hide answer" : "Show answer";
      answerBtn.addEventListener("click", () => {
        q._showAnswer = !q._showAnswer;
        renderAll();
      });
      rightGroup.appendChild(answerBtn);

      controlsRow.appendChild(rightGroup);

      wrapper.appendChild(controlsRow);

      if (q._showAnswer) {
        const answerDiv = document.createElement("div");
        answerDiv.className = "answer-block";

        const h3 = document.createElement("h3");
        h3.textContent = q.type === "sequence" ? "What comes fourth?" : "Connection";

        const p = document.createElement("p");
        p.innerHTML = `<strong>${q.answer}</strong>`;

        const small = document.createElement("small");
        small.textContent = q.explanation || "";

        answerDiv.appendChild(h3);
        answerDiv.appendChild(p);
        if (q.explanation) answerDiv.appendChild(small);

        wrapper.appendChild(answerDiv);
      }

      questionView.innerHTML = "";
      questionView.appendChild(wrapper);
    }

    function renderVowelsQuestion() {
      const round = getRound(currentRoundKey);
      const q = getCurrentQuestion();
      if (!q) return;

      // Auto-start 2-minute timer for vowels round (only once per entry)
      if (!timerRunning && timeRemaining === 0 && !timerContainer.classList.contains("active")) {
        startVowelsTimerAuto();
      }

      const totalClues = q.clues?.length || 0;
      const safeIndex = Math.max(0, Math.min(vowelsClueIndex, totalClues ? totalClues - 1 : 0));

      const wrapper = document.createElement("div");
      wrapper.className = "vowels-layout";

      const status = document.createElement("div");
      status.className = "vowels-status";
      status.textContent = `Topic ${currentQuestionIndex + 1} of ${round.questions.length} - Clue ${safeIndex + 1} of ${totalClues || 1}`;
      wrapper.appendChild(status);

      const topicBar = document.createElement("div");
      topicBar.className = "vowels-topic";
      topicBar.textContent = q.title || "Topic";
      wrapper.appendChild(topicBar);

      const clueBar = document.createElement("div");
      clueBar.className = "vowels-clue";
      const clueVal = q.clues[safeIndex];
      renderClueContent(clueBar, clueVal, false);
      wrapper.appendChild(clueBar);

      const controls = document.createElement("div");
      controls.className = "vowels-controls";

      const t1Btn = document.createElement("button");
      t1Btn.className = "btn-accent";
      t1Btn.textContent = `${teamNames.team1} +1`;
      t1Btn.addEventListener("click", () => {
        awardPoints('team1', 1, 'vowels');
        showVowelsAnswerBriefly(clueBar, clueVal);
      });
      controls.appendChild(t1Btn);

      const t2Btn = document.createElement("button");
      t2Btn.className = "btn-accent";
      t2Btn.textContent = `${teamNames.team2} +1`;
      t2Btn.addEventListener("click", () => {
        awardPoints('team2', 1, 'vowels');
        showVowelsAnswerBriefly(clueBar, clueVal);
      });
      controls.appendChild(t2Btn);

      const passBtn = document.createElement("button");
      passBtn.className = "btn-ghost";
      passBtn.textContent = "Pass / Next";
      passBtn.addEventListener("click", () => advanceVowelsClue());
      controls.appendChild(passBtn);

      const answerBtn = document.createElement("button");
      answerBtn.className = "btn-secondary";
      answerBtn.textContent = "Show answer";
      const answerBox = document.createElement("div");
      answerBox.style.cssText = "margin-top: 0.6rem; color: var(--text-muted); font-size: 0.95rem; display: none;";
      answerBox.innerHTML = `<strong style="color: var(--accent); font-size: 1rem;">${q.answer || ""}</strong>` + (q.explanation ? `<div style="margin-top:0.2rem;">${q.explanation}</div>` : "");
      answerBtn.addEventListener("click", () => {
        const showing = answerBox.style.display === "block";
        answerBox.style.display = showing ? "none" : "block";
        answerBtn.textContent = showing ? "Show answer" : "Hide answer";
      });
      controls.appendChild(answerBtn);

      wrapper.appendChild(controls);
      wrapper.appendChild(answerBox);

      questionView.innerHTML = "";
      questionView.appendChild(wrapper);
    }

    function resetClueState() {
      revealedClues = 0;
      vowelsClueIndex = 0;
      ['connection','sequence','vowels'].forEach((rk) => {
        usedQuestions[rk] = new Set();
      });
      // Hide any previously revealed answers/clues
      Object.values(quizData.years || {}).forEach((yearArr) => {
        (yearArr || []).forEach((quiz) => {
          Object.values(quiz.rounds || {}).forEach((round) => {
            (round.questions || []).forEach((qq) => {
              delete qq._showAnswer;
            });
          });
        });
      });
    }

    function attachAutoResize(el) {
      if (!el) return;
      el.style.overflow = "hidden";
      const resize = () => {
        el.style.height = "auto";
        el.style.height = el.scrollHeight + "px";
      };
      el.addEventListener("input", resize);
      resize();
    }

    function sprinkleCelebration(target, count = 24) {
      if (!target) return;
      target.style.position = target.style.position || 'relative';
      for (let i = 0; i < count; i++) {
        const s = document.createElement('div');
        s.className = 'sparkle';
        s.style.left = `${Math.random() * 100}%`;
        s.style.bottom = '0';
        s.style.animationDelay = `${Math.random() * 0.6}s`;
        s.style.animationDuration = `${1 + Math.random() * 0.8}s`;
        target.appendChild(s);
        setTimeout(() => s.remove(), 2200);
      }
    }

    function showRoundSummary(roundKey) {
      const existing = document.getElementById('roundSummary');
      if (existing) existing.remove();
      const round = getRound(roundKey);
      if (!round) return;
      const usedCount = usedQuestions[roundKey]?.size || 0;
      if (usedCount < (round.questions?.length || 0)) return;
      if (currentQuestionIndex !== null) return;

      const roundOrder = ['connection','sequence','vowels'];
      const idx = roundOrder.indexOf(roundKey);
      let nextRound = null;
      for (let i = idx + 1; i < roundOrder.length; i++) {
        if (getRound(roundOrder[i])) {
          nextRound = roundOrder[i];
          break;
        }
      }

      const overlay = document.createElement('div');
      overlay.id = 'roundSummary';
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.72);display:flex;align-items:center;justify-content:center;z-index:140;';
      overlay.innerHTML = `
        <div style="background:#020617;border:1px solid #1e293b;border-radius:1rem;padding:1.2rem 1.3rem;max-width:520px;width:90%;box-shadow:0 25px 60px rgba(0,0,0,0.6);">
          <h2 style="margin-bottom:0.6rem;color:var(--accent);text-transform:uppercase;letter-spacing:0.12em;font-size:0.95rem;">${round.label || 'Round complete'}</h2>
          <p style="color:var(--text-muted);margin-bottom:0.8rem;">Scores after this round:</p>
          <div style="display:flex;gap:1rem;margin-bottom:1rem;">
            <div style="flex:1;">
              <div style="font-weight:600;">${teamNames.team1}</div>
              <div style="font-size:1.25rem;">${teamScores.team1}</div>
            </div>
            <div style="flex:1;">
              <div style="font-weight:600;">${teamNames.team2}</div>
              <div style="font-size:1.25rem;">${teamScores.team2}</div>
            </div>
          </div>
          <div style="display:flex;gap:0.7rem;justify-content:flex-end;flex-wrap:wrap;">
            <button class="btn-secondary" id="roundStay">Close</button>
            <button class="btn-primary" id="roundNext">${nextRound ? 'Proceed to next round' : 'View final scores'}</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('#roundStay').addEventListener('click', () => overlay.remove());
      overlay.querySelector('#roundNext').addEventListener('click', () => {
        overlay.remove();
        if (nextRound) {
          currentRoundKey = nextRound;
          currentQuestionIndex = null;
          hideQuestionTimer();
          renderAll();
        } else {
          showEndOfQuizSummary();
        }
      });
    }

    function resetScoresAndNames() {
      if (!confirm('Start a new game? This will reset scores, team names, and clue progress.')) return;
      teamScores.team1 = 0; teamScores.team2 = 0;
      teamScoresPerRound.team1 = { connection: 0, sequence: 0, vowels: 0 };
      teamScoresPerRound.team2 = { connection: 0, sequence: 0, vowels: 0 };
      teamNames = { team1: 'Team 1', team2: 'Team 2' };
      try {
        localStorage.removeItem(SCORE_KEY);
        localStorage.removeItem(SCORE_BREAKDOWN_KEY);
        localStorage.removeItem(TEAM_NAMES_KEY);
      } catch (e) { /* ignore */ }
      resetClueState();
      onStartPage = true;
      currentYear = null;
      currentYearGroupId = null;
      currentRoundKey = 'connection';
      currentQuestionIndex = null;
      hideQuestionTimer();
      updateScoreDisplay();
      renderAll();
    }

    function showEndOfQuizSummary() {
      const existing = document.getElementById('quizSummaryModal');
      if (existing) existing.remove();
      
      const winner = teamScores.team1 > teamScores.team2 ? 'team1' : 
                     teamScores.team2 > teamScores.team1 ? 'team2' : 'tie';
      const winnerName = winner === 'team1' ? teamNames.team1 : 
                         winner === 'team2' ? teamNames.team2 : 'Both Teams';
      const isDraw = winner === 'tie';
      
      const modal = document.createElement('div');
      modal.id = 'quizSummaryModal';
      modal.style.cssText = 'position:fixed;inset:0;background:radial-gradient(circle at 50% 50%, rgba(56,189,248,0.15), rgba(0,0,0,0.9));display:flex;align-items:center;justify-content:center;z-index:120;backdrop-filter:blur(8px);animation:fadeIn 0.5s ease;';
      
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg, #020617 0%, #0a1628 100%);border:2px solid ${isDraw ? '#fbbf24' : 'var(--accent)'};border-radius:1.5rem;padding:3rem 2rem;max-width:700px;width:90%;box-shadow:0 30px 80px rgba(0,0,0,0.8), 0 0 100px ${isDraw ? 'rgba(251,191,36,0.3)' : 'rgba(56,189,248,0.3)'};text-align:center;position:relative;overflow:hidden;animation:scaleIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);">
          
          <!-- Animated background glow -->
          <div style="position:absolute;inset:0;background:radial-gradient(circle at 50% 50%, ${isDraw ? 'rgba(251,191,36,0.1)' : 'rgba(56,189,248,0.1)'}, transparent 70%);animation:pulse 2s ease-in-out infinite;pointer-events:none;"></div>
          
          <!-- Content -->
          <div style="position:relative;z-index:1;">
            <div style="font-size:4rem;margin-bottom:0.5rem;animation:bounce 1s ease;filter:drop-shadow(0 0 20px ${isDraw ? '#fbbf24' : 'var(--accent)'});">
              ${isDraw ? '🤝' : '🏆'}
            </div>
            
            <h1 style="font-size:2.5rem;font-weight:800;margin-bottom:1rem;background:linear-gradient(135deg, ${isDraw ? '#fbbf24, #f59e0b' : 'var(--accent), #60a5fa'});-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:0.05em;text-transform:uppercase;animation:glow 2s ease-in-out infinite;">
              ${isDraw ? "It's a Draw!" : 'Victory!'}
            </h1>
            
            ${!isDraw ? `<div style="font-size:1.5rem;color:var(--text-main);font-weight:600;margin-bottom:2rem;text-shadow:0 0 20px rgba(56,189,248,0.5);">
              ${winnerName} Wins!
            </div>` : '<div style="font-size:1.3rem;color:#fbbf24;font-weight:600;margin-bottom:2rem;text-shadow:0 0 20px rgba(251,191,36,0.5);">Both Teams Tied!</div>'}
            
            <!-- Score Display -->
            <div style="background:rgba(15,23,42,0.6);border-radius:1rem;padding:2rem;margin-bottom:2rem;border:1px solid rgba(56,189,248,0.2);">
              <div style="font-size:0.9rem;text-transform:uppercase;letter-spacing:0.15em;color:var(--text-muted);margin-bottom:1.5rem;">Final Scores</div>
              <div style="display:flex;justify-content:space-around;align-items:center;gap:2rem;flex-wrap:wrap;">
                <div style="flex:1;min-width:150px;${winner === 'team1' ? 'transform:scale(1.1);' : ''}">
                  <div style="font-size:1.2rem;font-weight:700;color:${winner === 'team1' ? 'var(--accent)' : 'var(--text-main)'};margin-bottom:0.5rem;${winner === 'team1' ? 'text-shadow:0 0 20px rgba(56,189,248,0.8);' : ''}">${teamNames.team1}</div>
                  <div style="font-size:3rem;font-weight:900;color:${winner === 'team1' ? 'var(--accent)' : 'var(--text-main)'};${winner === 'team1' ? 'text-shadow:0 0 30px rgba(56,189,248,0.8);animation:pulse 1.5s ease-in-out infinite;' : ''}">${teamScores.team1}</div>
                  ${winner === 'team1' ? '<div style="font-size:2rem;margin-top:0.5rem;">👑</div>' : ''}
                </div>
                
                <div style="font-size:2rem;color:var(--text-muted);opacity:0.5;">VS</div>
                
                <div style="flex:1;min-width:150px;${winner === 'team2' ? 'transform:scale(1.1);' : ''}">
                  <div style="font-size:1.2rem;font-weight:700;color:${winner === 'team2' ? 'var(--accent)' : 'var(--text-main)'};margin-bottom:0.5rem;${winner === 'team2' ? 'text-shadow:0 0 20px rgba(56,189,248,0.8);' : ''}">${teamNames.team2}</div>
                  <div style="font-size:3rem;font-weight:900;color:${winner === 'team2' ? 'var(--accent)' : 'var(--text-main)'};${winner === 'team2' ? 'text-shadow:0 0 30px rgba(56,189,248,0.8);animation:pulse 1.5s ease-in-out infinite;' : ''}">${teamScores.team2}</div>
                  ${winner === 'team2' ? '<div style="font-size:2rem;margin-top:0.5rem;">👑</div>' : ''}
                </div>
              </div>
            </div>
            
            <!-- Buttons -->
            <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
              <button class="btn-secondary" id="summaryClose" style="padding:0.75rem 2rem;font-size:1rem;">Close</button>
              <button class="btn-primary" id="summaryHome" style="padding:0.75rem 2rem;font-size:1rem;">Home & Reset</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.querySelector('#summaryClose').addEventListener('click', () => modal.remove());
      modal.querySelector('#summaryHome').addEventListener('click', () => {
        modal.remove();
        resetScoresAndNames();
      });
      
      // Enhanced celebration with more particles
      sprinkleCelebration(modal.firstElementChild, 50);
    }

    function showPointAnimation(text, color = '#38bdf8') {
      const anim = document.createElement('div');
      anim.className = 'point-award';
      anim.textContent = text;
      anim.style.color = color;
      document.body.appendChild(anim);
      setTimeout(() => anim.remove(), 1200);
    }

    function showVowelsAnswerBriefly(clueBar, clue) {
      // Get the answer from the clue object
      let answer = 'ANSWER';
      if (clue && typeof clue === 'object' && clue.answer) {
        answer = clue.answer;
      } else if (typeof clue === 'string') {
        answer = clue; // Fallback for old format
      }
      
      // Show the answer
      clueBar.innerHTML = '';
      const answerDiv = document.createElement('div');
      answerDiv.textContent = answer;
      answerDiv.style.cssText = 'color: #0c1a38; font-weight: 800; letter-spacing: 0.16em;';
      clueBar.appendChild(answerDiv);
      
      // After 1 second, advance to next clue
      setTimeout(() => {
        advanceVowelsClue();
      }, 1000);
    }

    function advanceVowelsClue() {
      const round = getRound('vowels');
      const q = getCurrentQuestion();
      if (!round || !q) return;
      const totalClues = q.clues?.length || 0;

      if (vowelsClueIndex < totalClues - 1) {
        vowelsClueIndex += 1;
        renderAll();
        return;
      }

      if (!usedQuestions['vowels']) usedQuestions['vowels'] = new Set();
      usedQuestions['vowels'].add(currentQuestionIndex);

      if (currentQuestionIndex < round.questions.length - 1) {
        currentQuestionIndex += 1;
        vowelsClueIndex = 0;
        advanceTeamTurn();
        renderAll();
      } else {
        currentQuestionIndex = null;
        vowelsClueIndex = 0;
        hideQuestionTimer();
        showEndOfQuizSummary();
        advanceTeamTurn();
        renderAll();
      }
    }
    function renderAll() {
      if (onStartPage) {
        renderStartPage();
        if (typeof saveAppState === 'function') saveAppState();
        return;
      }
      renderYearGroupSelect();
      renderRoundTabs();
      renderBreadcrumbs();
      if (currentQuestionIndex === null) {
        renderQuestionBoard();
      } else {
        renderQuestionBoard(); // ensure board state is consistent
        renderQuestionView();
      }
      if (typeof saveAppState === 'function') saveAppState();
    }

    function renderStartPage() {
      // Hide header controls on start page
      document.getElementById("teamPanel").style.display = "none";
      const yearGroupLabel = document.querySelector(".pill-label");
      const yearGroupSelect = document.getElementById("yearGroupSelect");
      if (yearGroupLabel) yearGroupLabel.style.display = "none";
      if (yearGroupSelect) yearGroupSelect.style.display = "none";
      
      questionList.style.display = "none";
      roundTabs.innerHTML = "";
      roundTabs.style.display = "none";
      breadcrumbsPath.innerHTML = "";
      breadcrumbsControls.innerHTML = "";
      
      const startPage = document.createElement("div");
      startPage.className = "start-page";
      startPage.innerHTML = `
        <svg style="width: 200px; height: 200px; margin-bottom: 1.5rem; margin-top: 0rem; opacity: 0.85; filter: drop-shadow(0 10px 30px rgba(56, 189, 248, 0.3));" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="segmentGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#38bdf8;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#0f88d9;stop-opacity:1" />
            </linearGradient>
          </defs>
          <!-- Outer ring segments -->
          <path d="M 100,20 A 80,80 0 0,1 154.64,34.64 L 145.36,43.93 A 65,65 0 0,0 100,35 Z" fill="#1e3a8a" opacity="0.8"/>
          <path d="M 154.64,34.64 A 80,80 0 0,1 180,100 L 165,100 A 65,65 0 0,0 145.36,54.64 Z" fill="#2563eb" opacity="0.9"/>
          <path d="M 180,100 A 80,80 0 0,1 154.64,165.36 L 145.36,156.07 A 65,65 0 0,0 165,100 Z" fill="#3b82f6" opacity="0.85"/>
          <path d="M 154.64,165.36 A 80,80 0 0,1 100,180 L 100,165 A 65,65 0 0,0 145.36,156.07 Z" fill="#60a5fa" opacity="0.9"/>
          <path d="M 100,180 A 80,80 0 0,1 45.36,165.36 L 54.64,156.07 A 65,65 0 0,0 100,165 Z" fill="#38bdf8" opacity="0.95"/>
          <path d="M 45.36,165.36 A 80,80 0 0,1 20,100 L 35,100 A 65,65 0 0,0 54.64,145.36 Z" fill="#0ea5e9" opacity="0.9"/>
          <path d="M 20,100 A 80,80 0 0,1 45.36,34.64 L 54.64,43.93 A 65,65 0 0,0 35,100 Z" fill="#0284c7" opacity="0.85"/>
          <path d="M 45.36,34.64 A 80,80 0 0,1 100,20 L 100,35 A 65,65 0 0,0 54.64,43.93 Z" fill="#0369a1" opacity="0.8"/>
          <!-- Middle ring segments -->
          <path d="M 100,50 A 50,50 0 0,1 135.36,64.64 L 126.07,73.93 A 35,35 0 0,0 100,65 Z" fill="url(#segmentGrad)" opacity="0.7"/>
          <path d="M 135.36,64.64 A 50,50 0 0,1 150,100 L 135,100 A 35,35 0 0,0 126.07,73.93 Z" fill="url(#segmentGrad)" opacity="0.8"/>
          <path d="M 150,100 A 50,50 0 0,1 135.36,135.36 L 126.07,126.07 A 35,35 0 0,0 135,100 Z" fill="url(#segmentGrad)" opacity="0.75"/>
          <path d="M 135.36,135.36 A 50,50 0 0,1 100,150 L 100,135 A 35,35 0 0,0 126.07,126.07 Z" fill="url(#segmentGrad)" opacity="0.8"/>
          <path d="M 100,150 A 50,50 0 0,1 64.64,135.36 L 73.93,126.07 A 35,35 0 0,0 100,135 Z" fill="url(#segmentGrad)" opacity="0.85"/>
          <path d="M 64.64,135.36 A 50,50 0 0,1 50,100 L 65,100 A 35,35 0 0,0 73.93,126.07 Z" fill="url(#segmentGrad)" opacity="0.8"/>
          <path d="M 50,100 A 50,50 0 0,1 64.64,64.64 L 73.93,73.93 A 35,35 0 0,0 65,100 Z" fill="url(#segmentGrad)" opacity="0.75"/>
          <path d="M 64.64,64.64 A 50,50 0 0,1 100,50 L 100,65 A 35,35 0 0,0 73.93,73.93 Z" fill="url(#segmentGrad)" opacity="0.7"/>
          <!-- Center circle -->
          <circle cx="100" cy="100" r="30" fill="#020617" opacity="0.8"/>
          <circle cx="100" cy="100" r="28" fill="none" stroke="#38bdf8" stroke-width="2" opacity="0.6"/>
        </svg>
        <div class="start-page-logo">CONIUNGITE</div>
        <div class="start-page-subtitle">Ludus Latinus</div>
        <div class="start-page-buttons">
          <button class="start-btn" data-start-play>▶️ Play</button>
        </div>
      `;

      questionView.innerHTML = "";
      questionView.classList.remove("question-mode");
      questionView.appendChild(startPage);
      questionView.classList.add("active");
      
      const playBtn = startPage.querySelector('[data-start-play]');
      const createBtn = startPage.querySelector('[data-start-create]');
      const setupBtn = startPage.querySelector('[data-start-setup]');
      
      if (playBtn) {
        playBtn.addEventListener('click', renderYearSelection);
      }
      if (createBtn) {
        createBtn.addEventListener('click', () => {
          onStartPage = false;
          if (typeof editor?.toggleMode === "function") {
            editor.toggleMode("edit");
          }
          renderAll();
        });
      }
      if (setupBtn) {
        setupBtn.addEventListener('click', showTeacherSetup);
      }
    }

    function renderYearSelection() {
      const years = Object.keys(quizData.years).sort((a, b) => b - a);
      const shell = document.createElement("div");
      shell.className = "start-page";
      shell.innerHTML = `
        <div class="start-page-logo" style="font-size: 2.2rem; margin-bottom: 1rem;">Choose Year</div>
        <div class="glyph-grid">
          ${years.map(y => `
            <button class="start-tile" data-year="${y}" style="height:140px;">
              <div style="font-size:1.4rem;letter-spacing:0.12em;">${y}</div>
            </button>
          `).join('')}
        </div>
        <div class="start-page-buttons" style="margin-top:1rem;">
          <button class="start-btn" style="background: rgba(56, 189, 248, 0.2); border: 1px solid var(--accent);" data-back-home="true">Back</button>
        </div>
      `;

      questionView.innerHTML = "";
      questionView.classList.add("active");
      questionView.appendChild(shell);

      shell.querySelectorAll('[data-year]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const year = parseInt(e.currentTarget.dataset.year);
          selectYear(year);
        });
      });
      const back = shell.querySelector('[data-back-home="true"]');
      if (back) back.addEventListener('click', () => renderStartPage());
    }

    function selectYear(year) {
      currentYear = year;
      renderYearQuizzes();
    }

    function renderYearQuizzes() {
      const quizzes = quizData.years[currentYear] || [];
      
      if (quizzes.length === 0) {
        // No quizzes for this year, go back to year selection
        onStartPage = true;
        currentYear = null;
        renderAll();
        return;
      }
      
      questionList.style.display = "none";
      
      const quizzesHTML = quizzes.map(qz => `
        <button class="start-tile" data-quiz-id="${qz.id}" style="height:140px;">
          <div style="font-size:0.95rem;letter-spacing:0.08em;line-height:1.2;">${qz.name}</div>
        </button>
      `).join('');
      
      const quizPage = document.createElement("div");
      quizPage.className = "start-page";
      quizPage.innerHTML = `
        <div class="start-page-logo" style="font-size: 2rem; margin-bottom: 1rem;">${currentYear}</div>
                <div class="start-page-subtitle">Select a Quiz</div>
        <div class="glyph-grid">
          ${quizzesHTML}
        </div>
        <div class="start-page-buttons" style="margin-top:1rem;">
          <button class="start-btn" style="background: rgba(56, 189, 248, 0.2); border: 1px solid var(--accent);" data-back-btn="true">
            Back
          </button>
        </div>
      `;
      
      questionView.innerHTML = "";
      questionView.classList.remove("question-mode");
      questionView.appendChild(quizPage);
      questionView.classList.add("active");
      
      // Add event listeners to quiz buttons
      quizPage.querySelectorAll('[data-quiz-id]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const quizId = e.currentTarget.dataset.quizId; // Use currentTarget instead of target
          console.log('Quiz button clicked. Year:', currentYear, 'QuizId:', quizId);
          promptTeamSetupForQuiz(quizId);
        });
      });
      
      // Add back button listener
      const backBtn = quizPage.querySelector('[data-back-btn="true"]');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          onStartPage = true;
          currentYear = null;
          renderAll();
        });
      }
    }

    function promptTeamSetupForQuiz(quizId) {
      // Ensure year is set BEFORE showing team setup modal
      if (!currentYear) {
        const foundYear = findYearForQuizId(quizId);
        if (foundYear) {
          currentYear = foundYear;
          console.log('Set year in promptTeamSetupForQuiz:', currentYear, 'for quiz:', quizId);
        } else {
          console.error('Could not find year for quiz in promptTeamSetupForQuiz:', quizId);
        }
      }
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:130;';
      overlay.innerHTML = `
        <div style="background:#020617;border:1px solid #1e293b;border-radius:1rem;padding:1.25rem;max-width:480px;width:90%;box-shadow:0 25px 60px rgba(0,0,0,0.7);">
          <h2 style="margin-bottom:0.75rem;color:var(--accent);">Set up teams</h2>
          <div class="form-group">
            <label>Team 1 name</label>
            <input type="text" id="preTeamName1" value="${teamNames.team1 || 'Team 1'}">
          </div>
          <div class="form-group" style="margin-top:0.5rem;">
            <label>Team 2 name</label>
            <input type="text" id="preTeamName2" value="${teamNames.team2 || 'Team 2'}">
          </div>
          <div style="display:flex;gap:0.6rem;justify-content:flex-end;margin-top:1rem;flex-wrap:wrap;">
            <button class="btn-ghost" data-skip>Skip</button>
            <button class="btn-secondary" data-cancel>Cancel</button>
            <button class="btn-primary" data-start>Start quiz</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      const close = () => overlay.remove();
      overlay.querySelector('[data-cancel]').addEventListener('click', close);
      overlay.querySelector('[data-skip]').addEventListener('click', () => {
        close();
        showTitleScreen(quizId);
      });
      overlay.querySelector('[data-start]').addEventListener('click', () => {
        const n1 = (document.getElementById('preTeamName1')?.value || '').trim() || 'Team 1';
        const n2 = (document.getElementById('preTeamName2')?.value || '').trim() || 'Team 2';
        teamNames = { team1: n1, team2: n2 };
        try { localStorage.setItem(TEAM_NAMES_KEY, JSON.stringify(teamNames)); } catch(e){}
        updateScoreDisplay();
        close();
        showTitleScreen(quizId);
      });
    }

    function showTitleScreen(yearGroupId) {
      console.log('showTitleScreen called with yearGroupId:', yearGroupId);
      console.log('Current year before lookup:', currentYear);
      
      // Always find and set the year to ensure proper loading
      const foundYear = findYearForQuizId(yearGroupId);
      if (foundYear) {
        currentYear = foundYear;
        console.log('Found and set year:', currentYear);
      } else {
        console.error('Could not find year for quiz:', yearGroupId);
        console.log('Available years:', Object.keys(quizData.years));
        console.log('All quiz IDs:', Object.entries(quizData.years).map(([year, quizzes]) => 
          ({ year, ids: quizzes.map(q => q.id) })
        ));
      }
      
      // Set currentYearGroupId early to ensure quiz can be found
      currentYearGroupId = yearGroupId;

      const quiz = getCurrentYearGroupById(yearGroupId);
      if (!quiz) {
        console.error('Could not find quiz:', yearGroupId, 'in year:', currentYear);
        console.error('currentYearGroupId:', currentYearGroupId);
        alert('Error: Could not load quiz. Please try again or check the browser console for details.');
        return;
      }
      console.log('Successfully loaded quiz:', quiz.name);
      const quizName = quiz.name;

      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:radial-gradient(circle at 50% 50%, #0a1628, #020617);display:flex;align-items:center;justify-content:center;z-index:130;';
      overlay.innerHTML = `
        <div style="text-align:center;max-width:700px;padding:2rem;">
          <h1 style="font-size:2.5rem;color:var(--accent);margin-bottom:1.5rem;letter-spacing:0.05em;text-transform:uppercase;">${quizName}</h1>
          <div style="display:flex;justify-content:center;gap:3rem;margin:2rem 0;flex-wrap:wrap;">
            <div style="text-align:center;">
              <div style="font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:0.5rem;">Team 1</div>
              <div style="font-size:1.8rem;font-weight:600;color:var(--text-main);">${teamNames.team1}</div>
              <div style="font-size:1.2rem;color:var(--text-muted);margin-top:0.25rem;">Score: 0</div>
            </div>
            <div style="font-size:3rem;color:var(--text-muted);align-self:center;">VS</div>
            <div style="text-align:center;">
              <div style="font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:0.5rem;">Team 2</div>
              <div style="font-size:1.8rem;font-weight:600;color:var(--text-main);">${teamNames.team2}</div>
              <div style="font-size:1.2rem;color:var(--text-muted);margin-top:0.25rem;">Score: 0</div>
            </div>
          </div>
          <button class="btn-primary" data-start-game style="margin-top:2rem;padding:1rem 3rem;font-size:1.2rem;">Start Quiz</button>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('[data-start-game]').addEventListener('click', () => {
        overlay.remove();
        startQuiz(yearGroupId);
      });
    }

    function getCurrentYearGroupById(yearGroupId) {
      for (const yearKey of Object.keys(quizData.years)) {
        const quizzes = quizData.years[yearKey] || [];
        const found = quizzes.find(q => q.id === yearGroupId);
        if (found) return found;
      }
      return null;
    }

    function startQuiz(yearGroupId) {
      // Ensure the year is always set properly
      if (!currentYear) {
        const foundYear = findYearForQuizId(yearGroupId);
        if (foundYear) {
          currentYear = foundYear;
        } else {
          console.error('Could not find year for quiz:', yearGroupId);
        }
      }

      // Verify the quiz exists before starting
      const quiz = getCurrentYearGroup();
      if (!quiz) {
        console.error('Quiz not found. Year:', currentYear, 'QuizId:', yearGroupId);
        alert('Error: Could not load quiz. Returning to home.');
        onStartPage = true;
        renderAll();
        return;
      }

      // Show header controls when starting quiz, but hide the year group dropdown (redundant once quiz started)
      document.getElementById("teamPanel").style.display = "flex";
      const yearGroupLabel = document.querySelector(".pill-label");
      const yearGroupSelect = document.getElementById("yearGroupSelect");
      if (yearGroupLabel) yearGroupLabel.style.display = "none";
      if (yearGroupSelect) yearGroupSelect.style.display = "none";
      
      onStartPage = false;
      currentYearGroupId = yearGroupId;
      currentRoundKey = "connection";
      currentQuestionIndex = null;
      resetClueState();
      renderAll();
    }

    // ----------------------------------------
    // EVENTS
    // ----------------------------------------

    const logoBlock = document.getElementById("logoBlock");
    logoBlock.addEventListener("click", () => {
      // Always jump back to the start page and exit create mode
      if (typeof editor?.toggleMode === "function") {
        editor.toggleMode("play");
      }
      onStartPage = true;
      currentYear = null;
      currentYearGroupId = null;
      currentRoundKey = "connection";
      currentQuestionIndex = null;
      revealedClues = 0;
      resetClueState();
      hideQuestionTimer();
      renderAll();
    });

    yearGroupSelect.addEventListener("change", (e) => {
      currentYearGroupId = e.target.value;
      currentQuestionIndex = null;
      revealedClues = 0;
      renderAll();
    });

    // ----------------------------------------
    // QUIZ MANAGER
    // ----------------------------------------

    const quizManager = {
      // CSV/Excel Import
      showImportModal() {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:150;';
        modal.innerHTML = `
          <div style="background:#020617;border:1px solid #1e293b;border-radius:1rem;padding:1.5rem;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;">
            <h2 style="color:var(--accent);margin-bottom:1rem;font-size:1.1rem;">Import Questions from CSV/Excel</h2>
            
            <div class="file-drop-zone" id="dropZone">
              <div style="font-size:2rem;margin-bottom:0.5rem;">📄</div>
              <p style="color:var(--text-muted);margin-bottom:0.5rem;">Drag & drop CSV file here or click to browse</p>
              <input type="file" id="csvFileInput" accept=".csv,.xlsx,.xls" style="display:none;">
              <button class="btn-secondary" onclick="document.getElementById('csvFileInput').click()">Select File</button>
            </div>
            
            <div id="csvPreview" class="csv-preview" style="display:none;"></div>
            
            <details style="margin-top:1rem;padding:0.8rem;background:rgba(30,41,59,0.5);border-radius:0.5rem;">
              <summary style="cursor:pointer;color:var(--accent);font-size:0.8rem;">CSV Format Guide</summary>
              <div style="margin-top:0.5rem;font-size:0.7rem;color:var(--text-muted);">
                <p style="margin-bottom:0.5rem;"><strong>Required columns:</strong></p>
                <ul style="margin-left:1.5rem;">
                  <li><code>type</code>: connection, sequence, or vowels</li>
                  <li><code>glyph</code>: lion, water, flax, eye, two-reeds, horned-viper</li>
                  <li><code>title</code>: Question title/topic</li>
                  <li><code>clue1, clue2, clue3, clue4</code>: The clues (clue4 optional for vowels)</li>
                  <li><code>answer</code>: The correct answer</li>
                  <li><code>explanation</code>: Optional explanation text</li>
                </ul>
                <p style="margin-top:0.5rem;"><strong>Example row:</strong></p>
                <code style="display:block;margin-top:0.3rem;padding:0.3rem;background:#020617;border-radius:0.3rem;">connection,lion,Roman Emperors,Augustus,Tiberius,Caligula,Claudius,First four emperors,Julio-Claudian dynasty</code>
              </div>
            </details>
            
            <div style="display:flex;justify-content:space-between;gap:0.8rem;margin-top:1rem;">
              <button class="btn-ghost" onclick="this.closest('div[style*=fixed]').remove()">Cancel</button>
              <button class="btn-primary" id="importBtn" style="display:none;" onclick="quizManager.processImport()">Import Questions</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        const dropZone = modal.querySelector('#dropZone');
        const fileInput = modal.querySelector('#csvFileInput');
        const preview = modal.querySelector('#csvPreview');
        const importBtn = modal.querySelector('#importBtn');
        
        dropZone.onclick = () => fileInput.click();
        
        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          if (file) quizManager.parseCSV(file, preview, importBtn);
        };
        
        dropZone.ondragover = (e) => {
          e.preventDefault();
          dropZone.classList.add('drag-over');
        };
        
        dropZone.ondragleave = () => {
          dropZone.classList.remove('drag-over');
        };
        
        dropZone.ondrop = (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          const file = e.dataTransfer.files[0];
          if (file) quizManager.parseCSV(file, preview, importBtn);
        };
      },

      parseCSV(file, previewEl, importBtn) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          const lines = text.split('\n').filter(l => l.trim());
          if (lines.length < 2) {
            alert('CSV file appears empty or invalid');
            return;
          }
          
          const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
          const data = [];
          
          for (let i = 1; i < lines.length; i++) {
            const values = quizManager.parseCSVLine(lines[i]);
            const row = {};
            headers.forEach((h, idx) => {
              row[h] = values[idx] ? values[idx].trim() : '';
            });
            data.push(row);
          }
          
          quizManager.csvData = data;
          
          // Show preview
          previewEl.style.display = 'block';
          previewEl.innerHTML = `
            <table>
              <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
              <tbody>
                ${data.slice(0, 5).map(row => 
                  `<tr>${headers.map(h => `<td>${(row[h] || '').substring(0, 30)}${row[h] && row[h].length > 30 ? '...' : ''}</td>`).join('')}</tr>`
                ).join('')}
              </tbody>
            </table>
            <p style="text-align:center;margin-top:0.5rem;color:var(--text-muted);">Showing first 5 of ${data.length} rows</p>
          `;
          
          importBtn.style.display = 'inline-block';
        };
        reader.readAsText(file);
      },

      parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current);
        return result;
      },

      processImport() {
        if (!quizManager.csvData) return;
        
        let imported = 0;
        quizManager.csvData.forEach(row => {
          const type = row.type || row.round;
          if (!['connection', 'sequence', 'vowels'].includes(type)) return;
          
          const clues = [];
          for (let i = 1; i <= 4; i++) {
            const clue = row[`clue${i}`] || row[`clue_${i}`] || '';
            if (clue) clues.push(clue);
          }
          
          if (clues.length === 0) return;
          
          const question = {
            id: Date.now() + imported,
            glyph: row.glyph || 'lion',
            code: row.code || '',
            title: row.title || row.topic || '',
            type: type === 'connection' ? 'connection' : type,
            clues: clues,
            answer: row.answer || '',
            explanation: row.explanation || row.notes || ''
          };
          
          const targetArray = type === 'connection' ? 'connections' : type;
          if (editor.data[targetArray]) {
            editor.data[targetArray].push(question);
            imported++;
          }
        });
        
        alert(`Successfully imported ${imported} questions!`);
        editor.render();
        document.querySelector('div[style*="fixed"]').remove();
      },

      // Question Randomization
      randomizeQuestions() {
        if (!confirm('Randomize all questions within their rounds?')) return;
        
        ['connections', 'sequence', 'vowels'].forEach(type => {
          const arr = editor.data[type];
          if (arr && arr.length > 0) {
            // Fisher-Yates shuffle
            for (let i = arr.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [arr[i], arr[j]] = [arr[j], arr[i]];
            }
          }
        });
        
        editor.render();
        alert('Questions randomized!');
      },

      // Duplicate Detection
      detectDuplicates() {
        const duplicates = [];
        const seen = new Map();
        
        ['connections', 'sequence', 'vowels'].forEach(type => {
          const arr = editor.data[type] || [];
          arr.forEach((q, idx) => {
            const key = `${q.title}|${q.answer}`.toLowerCase();
            if (seen.has(key)) {
              duplicates.push({
                type,
                index1: seen.get(key),
                index2: idx,
                title: q.title,
                answer: q.answer
              });
            } else {
              seen.set(key, idx);
            }
          });
        });
        
        if (duplicates.length === 0) {
          alert('No duplicates found!');
          return;
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:150;';
        modal.innerHTML = `
          <div style="background:#020617;border:1px solid #1e293b;border-radius:1rem;padding:1.5rem;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
            <h2 style="color:var(--accent);margin-bottom:1rem;">⚠️ Duplicate Questions Found</h2>
            <p style="color:var(--text-muted);margin-bottom:1rem;">Found ${duplicates.length} potential duplicate(s):</p>
            <div style="display:flex;flex-direction:column;gap:0.5rem;">
              ${duplicates.map(d => `
                <div class="duplicate-warning">
                  <strong>${d.type}</strong> - "${d.title}"<br>
                  <small>Answer: ${d.answer}</small>
                </div>
              `).join('')}
            </div>
            <button class="btn-primary" style="margin-top:1rem;" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
          </div>
        `;
        document.body.appendChild(modal);
      },

      // Templates
      showTemplates() {
        const templates = {
          'grammar-basics': {
            name: 'Latin Grammar Basics',
            description: '12 questions covering cases, conjugations, and declensions',
            id: 'template-grammar-basics',
            data: {
              connections: [
                { id: Date.now(), glyph: 'lion', code: '', title: 'First Declension Endings', type: 'connection', clues: ['-a', '-ae', '-am', '-ā'], answer: 'First declension singular endings', explanation: '' },
                { id: Date.now()+1, glyph: 'water', code: '', title: 'Nominative Case Uses', type: 'connection', clues: ['Subject', 'Predicate', 'Apposition', 'Address'], answer: 'Uses of the nominative case', explanation: '' },
                { id: Date.now()+2, glyph: 'flax', code: '', title: 'First Conjugation', type: 'connection', clues: ['amo', 'porto', 'laudo', 'paro'], answer: 'First conjugation verbs', explanation: '' },
                { id: Date.now()+3, glyph: 'eye', code: '', title: 'Ablative Case Uses', type: 'connection', clues: ['Means', 'Manner', 'Time', 'Place'], answer: 'Uses of the ablative case', explanation: '' }
              ],
              sequence: [
                { id: Date.now()+4, glyph: 'lion', code: '', title: 'Cases in Order', type: 'sequence', clues: ['Nominative', 'Genitive', 'Dative'], answer: 'Accusative', explanation: 'The six Latin cases' },
                { id: Date.now()+5, glyph: 'water', code: '', title: 'Person Markers', type: 'sequence', clues: ['-o/-m', '-s', '-t'], answer: '-mus', explanation: 'Verb endings for persons' },
                { id: Date.now()+6, glyph: 'flax', code: '', title: 'Principal Parts', type: 'sequence', clues: ['amo', 'amare', 'amavi'], answer: 'amatus', explanation: 'Four principal parts of amo' },
                { id: Date.now()+7, glyph: 'eye', code: '', title: 'Tense Sequence', type: 'sequence', clues: ['Present', 'Imperfect', 'Future'], answer: 'Perfect', explanation: 'Order of Latin tenses' }
              ],
              vowels: [
                { id: Date.now()+8, glyph: 'lion', code: '', title: 'Latin Cases', type: 'vowels', clues: ['NMN TV'], answer: 'NOMINATIVE', explanation: '' },
                { id: Date.now()+9, glyph: 'water', code: '', title: 'Latin Cases', type: 'vowels', clues: ['GN TV'], answer: 'GENITIVE', explanation: '' },
                { id: Date.now()+10, glyph: 'flax', code: '', title: 'Latin Cases', type: 'vowels', clues: ['BL TV'], answer: 'ABLATIVE', explanation: '' },
                { id: Date.now()+11, glyph: 'eye', code: '', title: 'Latin Verb', type: 'vowels', clues: ['M'], answer: 'AMO', explanation: '' }
              ]
            }
          },
          'mythology': {
            name: 'Roman Mythology',
            description: '12 questions about gods, heroes, and myths',
            data: {
              connections: [
                { id: Date.now(), glyph: 'lion', code: '', title: 'Olympian Gods', type: 'connection', clues: ['Jupiter', 'Neptune', 'Mars', 'Apollo'], answer: 'Major Roman gods', explanation: '' },
                { id: Date.now()+1, glyph: 'water', code: '', title: 'Labours of Hercules', type: 'connection', clues: ['Nemean Lion', 'Hydra', 'Cerberus', 'Apples'], answer: 'Labours of Hercules', explanation: '' },
                { id: Date.now()+2, glyph: 'flax', code: '', title: 'Trojan War', type: 'connection', clues: ['Helen', 'Paris', 'Wooden Horse', 'Odysseus'], answer: 'Elements of the Trojan War', explanation: '' },
                { id: Date.now()+3, glyph: 'eye', code: '', title: 'Underworld', type: 'connection', clues: ['Styx', 'Charon', 'Cerberus', 'Pluto'], answer: 'Roman underworld mythology', explanation: '' }
              ],
              sequence: [
                { id: Date.now()+4, glyph: 'lion', code: '', title: 'Generation of Gods', type: 'sequence', clues: ['Chaos', 'Gaia', 'Uranus'], answer: 'Cronus/Saturn', explanation: '' },
                { id: Date.now()+5, glyph: 'water', code: '', title: 'Aeneas Journey', type: 'sequence', clues: ['Troy', 'Carthage', 'Sicily'], answer: 'Italy', explanation: '' },
                { id: Date.now()+6, glyph: 'flax', code: '', title: 'Roman Kings', type: 'sequence', clues: ['Romulus', 'Numa', 'Tullus'], answer: 'Ancus', explanation: 'First four kings of Rome' },
                { id: Date.now()+7, glyph: 'eye', code: '', title: 'Olympian Hierarchy', type: 'sequence', clues: ['Jupiter', 'Juno', 'Neptune'], answer: 'Pluto', explanation: 'Order of power' }
              ],
              vowels: [
                { id: Date.now()+8, glyph: 'lion', code: '', title: 'Roman Gods', type: 'vowels', clues: ['JP TR'], answer: 'JUPITER', explanation: '' },
                { id: Date.now()+9, glyph: 'water', code: '', title: 'Roman Gods', type: 'vowels', clues: ['MRS'], answer: 'MARS', explanation: '' },
                { id: Date.now()+10, glyph: 'flax', code: '', title: 'Heroes', type: 'vowels', clues: ['HRC LS'], answer: 'HERCULES', explanation: '' },
                { id: Date.now()+11, glyph: 'eye', code: '', title: 'Heroes', type: 'vowels', clues: ['N S'], answer: 'AENEAS', explanation: '' }
              ]
            }
          },
          'vocabulary': {
            name: 'Essential Vocabulary',
            description: '12 questions on common Latin words and phrases',
            data: {
              connections: [
                { id: Date.now(), glyph: 'lion', code: '', title: 'Family Members', type: 'connection', clues: ['pater', 'mater', 'filius', 'filia'], answer: 'Latin words for family members', explanation: '' },
                { id: Date.now()+1, glyph: 'water', code: '', title: 'Colors', type: 'connection', clues: ['albus', 'niger', 'ruber', 'viridis'], answer: 'Latin color words', explanation: '' },
                { id: Date.now()+2, glyph: 'flax', code: '', title: 'Body Parts', type: 'connection', clues: ['caput', 'manus', 'pes', 'oculus'], answer: 'Latin body parts', explanation: '' },
                { id: Date.now()+3, glyph: 'eye', code: '', title: 'Numbers', type: 'connection', clues: ['unus', 'duo', 'tres', 'quattuor'], answer: 'First four Latin numbers', explanation: '' }
              ],
              sequence: [
                { id: Date.now()+4, glyph: 'lion', code: '', title: 'Days of Week', type: 'sequence', clues: ['dies Lunae', 'dies Martis', 'dies Mercurii'], answer: 'dies Iovis', explanation: 'Latin days of the week' },
                { id: Date.now()+5, glyph: 'water', code: '', title: 'Months', type: 'sequence', clues: ['Ianuarius', 'Februarius', 'Martius'], answer: 'Aprilis', explanation: 'Latin months' },
                { id: Date.now()+6, glyph: 'flax', code: '', title: 'Numbers', type: 'sequence', clues: ['quinque', 'sex', 'septem'], answer: 'octo', explanation: 'Counting 5-8' },
                { id: Date.now()+7, glyph: 'eye', code: '', title: 'Size Order', type: 'sequence', clues: ['minimus', 'parvus', 'medius'], answer: 'magnus', explanation: 'From smallest to largest' }
              ],
              vowels: [
                { id: Date.now()+8, glyph: 'lion', code: '', title: 'Latin Phrases', type: 'vowels', clues: ['CR PD M'], answer: 'CARPE DIEM', explanation: '' },
                { id: Date.now()+9, glyph: 'water', code: '', title: 'Latin Phrases', type: 'vowels', clues: ['VN VD VC'], answer: 'VENI VIDI VICI', explanation: '' },
                { id: Date.now()+10, glyph: 'flax', code: '', title: 'Latin Words', type: 'vowels', clues: ['P TR'], answer: 'PATER', explanation: '' },
                { id: Date.now()+11, glyph: 'eye', code: '', title: 'Latin Words', type: 'vowels', clues: ['M TR'], answer: 'MATER', explanation: '' }
              ]
            }
          },
          'history': {
            name: 'Roman History',
            description: '12 questions on Roman emperors, battles, and events',
            data: {
              connections: [
                { id: Date.now(), glyph: 'lion', code: '', title: 'Julio-Claudians', type: 'connection', clues: ['Augustus', 'Tiberius', 'Caligula', 'Claudius'], answer: 'First four Roman emperors', explanation: '' },
                { id: Date.now()+1, glyph: 'water', code: '', title: 'Famous Battles', type: 'connection', clues: ['Cannae', 'Zama', 'Actium', 'Pharsalus'], answer: 'Famous Roman battles', explanation: '' },
                { id: Date.now()+2, glyph: 'flax', code: '', title: 'Roman Structures', type: 'connection', clues: ['Colosseum', 'Forum', 'Circus Maximus', 'Pantheon'], answer: 'Famous Roman buildings', explanation: '' },
                { id: Date.now()+3, glyph: 'eye', code: '', title: 'Military Units', type: 'connection', clues: ['Legion', 'Cohort', 'Century', 'Maniple'], answer: 'Roman military divisions', explanation: '' }
              ],
              sequence: [
                { id: Date.now()+4, glyph: 'lion', code: '', title: 'Emperors', type: 'sequence', clues: ['Claudius', 'Caligula', 'Tiberius'], answer: 'Augustus', explanation: 'First four emperors backwards' },
                { id: Date.now()+5, glyph: 'water', code: '', title: 'Punic Wars', type: 'sequence', clues: ['First Punic War', 'Second Punic War', 'Third Punic War'], answer: 'Carthage destroyed', explanation: '' },
                { id: Date.now()+6, glyph: 'flax', code: '', title: 'Roman Expansion', type: 'sequence', clues: ['Italy', 'Sicily', 'Spain'], answer: 'Greece', explanation: 'Order of conquest' },
                { id: Date.now()+7, glyph: 'eye', code: '', title: 'Caesar\'s Career', type: 'sequence', clues: ['Consul', 'Gaul', 'Rubicon'], answer: 'Dictator', explanation: '' }
              ],
              vowels: [
                { id: Date.now()+8, glyph: 'lion', code: '', title: 'Emperors', type: 'vowels', clues: ['GS TS'], answer: 'AUGUSTUS', explanation: '' },
                { id: Date.now()+9, glyph: 'water', code: '', title: 'Emperors', type: 'vowels', clues: ['NR'], answer: 'NERO', explanation: '' },
                { id: Date.now()+10, glyph: 'flax', code: '', title: 'Generals', type: 'vowels', clues: ['JL SCS R'], answer: 'JULIUS CAESAR', explanation: '' },
                { id: Date.now()+11, glyph: 'eye', code: '', title: 'Generals', type: 'vowels', clues: ['HNN BL'], answer: 'HANNIBAL', explanation: '' }
              ]
            }
          }
        };
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:150;';
        modal.innerHTML = `
          <div style="background:#020617;border:1px solid #1e293b;border-radius:1rem;padding:1.5rem;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;">
            <h2 style="color:var(--accent);margin-bottom:1rem;">📋 Quiz Templates</h2>
            <p style="color:var(--text-muted);margin-bottom:1rem;">Select a template to start with pre-made questions:</p>
            <div class="template-grid">
              ${Object.entries(templates).map(([id, t]) => `
                <div class="template-card" onclick="quizManager.loadTemplate('${id}')">
                  <h4>${t.name}</h4>
                  <p>${t.description}</p>
                </div>
              `).join('')}
            </div>
            <button class="btn-ghost" style="margin-top:1rem;" onclick="this.closest('div[style*=fixed]').remove()">Cancel</button>
          </div>
        `;
        document.body.appendChild(modal);
        
        quizManager.templates = templates;
      },

      loadTemplate(templateId) {
        const template = quizManager.templates[templateId];
        if (!template) return;
        
        if (!confirm(`Load template "${template.name}"? This will replace current questions.`)) return;
        
        editor.data = JSON.parse(JSON.stringify(template.data));
        editor.initializeEmptyRounds();
        editor.render();
        document.querySelector('div[style*="fixed"]').remove();
        alert('Template loaded!');
      },

      // Version History
      showVersionHistory() {
        const history = quizManager.getVersionHistory();
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:150;';
        modal.innerHTML = `
          <div style="background:#020617;border:1px solid #1e293b;border-radius:1rem;padding:1.5rem;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
            <h2 style="color:var(--accent);margin-bottom:1rem;">📜 Version History</h2>
            ${history.length === 0 ? '<p style="color:var(--text-muted);">No saved versions yet. Versions are created automatically when you save.</p>' : ''}
            <div style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:1rem;">
              ${history.map((v, idx) => `
                <div class="version-item">
                  <div class="version-info">
                    <div class="version-timestamp">${new Date(v.timestamp).toLocaleString()}</div>
                    <div class="version-label">${v.name || 'Unnamed Quiz'} (${v.questionCount} questions)</div>
                  </div>
                  <div style="display:flex;gap:0.3rem;">
                    <button class="btn-secondary btn-sm" onclick="quizManager.restoreVersion(${idx})">Restore</button>
                    <button class="btn-danger btn-sm" onclick="quizManager.deleteVersion(${idx})">Delete</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <button class="btn-ghost" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
          </div>
        `;
        document.body.appendChild(modal);
      },

      getVersionHistory() {
        try {
          const history = localStorage.getItem('quizVersionHistory');
          return history ? JSON.parse(history) : [];
        } catch (e) {
          return [];
        }
      },

      saveVersion(quizName, data) {
        const history = quizManager.getVersionHistory();
        const version = {
          timestamp: Date.now(),
          name: quizName,
          data: JSON.parse(JSON.stringify(data)),
          questionCount: (data.connections?.length || 0) + (data.sequence?.length || 0) + (data.vowels?.length || 0)
        };
        
        history.unshift(version);
        
        // Keep only last 20 versions
        if (history.length > 20) {
          history.splice(20);
        }
        
        try {
          localStorage.setItem('quizVersionHistory', JSON.stringify(history));
        } catch (e) {
          console.error('Failed to save version history:', e);
        }
      },

      restoreVersion(index) {
        const history = quizManager.getVersionHistory();
        const version = history[index];
        if (!version) return;
        
        if (!confirm(`Restore version from ${new Date(version.timestamp).toLocaleString()}? Current work will be replaced.`)) return;
        
        editor.data = JSON.parse(JSON.stringify(version.data));
        document.getElementById('quizName').value = version.name;
        editor.render();
        document.querySelector('div[style*="fixed"]').remove();
        alert('Version restored!');
      },

      deleteVersion(index) {
        if (!confirm('Delete this version?')) return;
        
        const history = quizManager.getVersionHistory();
        history.splice(index, 1);
        
        try {
          localStorage.setItem('quizVersionHistory', JSON.stringify(history));
        } catch (e) {
          console.error('Failed to update version history:', e);
        }
        
        // Refresh the modal
        document.querySelector('div[style*="fixed"]').remove();
        quizManager.showVersionHistory();
      },

      // Reuse Questions from Other Quizzes
      showReuseModal(roundType) {
        // Get all quizzes across all years
        const allQuizzes = [];
        Object.keys(quizData.years || {}).forEach(year => {
          (quizData.years[year] || []).forEach(quiz => {
            allQuizzes.push({ year, quiz });
          });
        });

        if (allQuizzes.length === 0) {
          alert('No other quizzes found. Create and save some quizzes first!');
          return;
        }

        const roundNames = {
          'connection': 'Connections',
          'sequence': 'Sequences',
          'vowels': 'Missing Vowels'
        };

        const roundKeys = {
          'connection': 'connection',
          'sequence': 'sequence',
          'vowels': 'vowels'
        };

        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:160;';
        modal.innerHTML = `
          <div style="background:#020617;border:1px solid #1e293b;border-radius:1rem;padding:1.5rem;max-width:900px;width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;">
            <h2 style="color:var(--accent);margin-bottom:0.5rem;font-size:1.1rem;">↻ Reuse ${roundNames[roundType]} Questions</h2>
            <p style="color:var(--text-muted);margin-bottom:1rem;font-size:0.8rem;">Select questions from other quizzes to add to your current quiz</p>
            
            <div style="display:grid;grid-template-columns:1fr 2fr;gap:1rem;flex:1;overflow:hidden;">
              <div style="overflow:hidden;display:flex;flex-direction:column;">
                <h3 style="color:var(--text-main);font-size:0.85rem;margin-bottom:0.5rem;">Available Quizzes</h3>
                <div id="reuseQuizList" class="reuse-quiz-list"></div>
              </div>
              
              <div style="overflow:hidden;display:flex;flex-direction:column;">
                <h3 style="color:var(--text-main);font-size:0.85rem;margin-bottom:0.5rem;">Questions <span id="reuseQuizName" style="color:var(--text-muted);font-weight:normal;">(select a quiz)</span></h3>
                <div id="reuseSelectionCount" class="reuse-selection-count" style="display:none;">0 questions selected</div>
                <div id="reuseQuestionList" class="reuse-question-list">
                  <p style="color:var(--text-muted);text-align:center;padding:2rem;">Select a quiz from the left to view its questions</p>
                </div>
              </div>
            </div>
            
            <div style="display:flex;justify-content:space-between;gap:0.8rem;margin-top:1rem;flex-wrap:wrap;">
              <button class="btn-ghost" onclick="this.closest('div[style*=fixed]').remove()">Cancel</button>
              <div style="display:flex;gap:0.5rem;">
                <button class="btn-secondary" id="reuseSelectAll">Select All</button>
                <button class="btn-secondary" id="reuseClearSelection">Clear Selection</button>
                <button class="btn-primary" id="reuseAddBtn" disabled>Add Selected Questions</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        const quizListEl = modal.querySelector('#reuseQuizList');
        const questionListEl = modal.querySelector('#reuseQuestionList');
        const quizNameEl = modal.querySelector('#reuseQuizName');
        const selectionCountEl = modal.querySelector('#reuseSelectionCount');
        const addBtn = modal.querySelector('#reuseAddBtn');
        const selectAllBtn = modal.querySelector('#reuseSelectAll');
        const clearSelectionBtn = modal.querySelector('#reuseClearSelection');

        let selectedQuestions = new Set();
        let currentQuizQuestions = [];

        function updateSelectionCount() {
          const count = selectedQuestions.size;
          if (count > 0) {
            selectionCountEl.textContent = `${count} question${count > 1 ? 's' : ''} selected`;
            selectionCountEl.style.display = 'block';
            addBtn.disabled = false;
          } else {
            selectionCountEl.style.display = 'none';
            addBtn.disabled = true;
          }
        }

        function renderQuestions(quiz) {
          const roundKey = roundKeys[roundType];
          const questions = quiz.rounds?.[roundKey]?.questions || [];
          currentQuizQuestions = questions;

          if (questions.length === 0) {
            questionListEl.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:2rem;">No questions in this round</p>';
            return;
          }

          questionListEl.innerHTML = '';
          questions.forEach((q, idx) => {
            const card = document.createElement('div');
            card.className = 'reuse-question-card';
            const uniqueId = `${quiz.id}-${idx}`;
            
            if (selectedQuestions.has(uniqueId)) {
              card.classList.add('selected');
            }

            const glyphIcon = q.glyph ? `<img src="glyph-${q.glyph}.png" style="width:20px;height:20px;object-fit:contain;vertical-align:middle;">` : '';
            const title = q.title || 'Untitled Question';
            const cluesPreview = q.clues ? q.clues.filter(c => c).slice(0, 2).join(', ') : '';
            const answer = q.answer || 'No answer';

            card.innerHTML = `
              <div class="reuse-question-title">
                ${glyphIcon}
                <span>${title}</span>
              </div>
              <div class="reuse-question-details">Clues: ${cluesPreview}${q.clues && q.clues.filter(c => c).length > 2 ? '...' : ''}</div>
              <div class="reuse-question-preview">Answer: ${answer.substring(0, 60)}${answer.length > 60 ? '...' : ''}</div>
            `;

            card.onclick = () => {
              if (selectedQuestions.has(uniqueId)) {
                selectedQuestions.delete(uniqueId);
                card.classList.remove('selected');
              } else {
                selectedQuestions.add(uniqueId);
                card.classList.add('selected');
              }
              updateSelectionCount();
            };

            questionListEl.appendChild(card);
          });
        }

        // Render quiz list
        allQuizzes.forEach(({ year, quiz }) => {
          const roundKey = roundKeys[roundType];
          const questionCount = quiz.rounds?.[roundKey]?.questions?.length || 0;
          
          if (questionCount === 0) return; // Skip quizzes with no questions in this round

          const item = document.createElement('div');
          item.className = 'reuse-quiz-item';
          item.innerHTML = `
            <div>
              <div style="font-size:0.8rem;font-weight:600;">${quiz.name}</div>
              <div style="font-size:0.7rem;color:var(--text-muted);">${year} • ${questionCount} question${questionCount > 1 ? 's' : ''}</div>
            </div>
          `;

          item.onclick = () => {
            document.querySelectorAll('.reuse-quiz-item').forEach(el => el.classList.remove('active'));
            item.classList.add('active');
            quizNameEl.textContent = `from "${quiz.name}"`;
            renderQuestions(quiz);
          };

          quizListEl.appendChild(item);
        });

        // Select All button
        selectAllBtn.onclick = () => {
          currentQuizQuestions.forEach((q, idx) => {
            const activeQuiz = document.querySelector('.reuse-quiz-item.active');
            if (activeQuiz) {
              const quizId = allQuizzes.find(({ quiz }) => 
                activeQuiz.textContent.includes(quiz.name)
              )?.quiz.id;
              if (quizId) {
                selectedQuestions.add(`${quizId}-${idx}`);
              }
            }
          });
          document.querySelectorAll('.reuse-question-card').forEach(card => {
            card.classList.add('selected');
          });
          updateSelectionCount();
        };

        // Clear Selection button
        clearSelectionBtn.onclick = () => {
          selectedQuestions.clear();
          document.querySelectorAll('.reuse-question-card').forEach(card => {
            card.classList.remove('selected');
          });
          updateSelectionCount();
        };

        // Add button
        addBtn.onclick = () => {
          const questionsToAdd = [];
          
          selectedQuestions.forEach(id => {
            const [quizId, idx] = id.split('-');
            const sourceQuiz = allQuizzes.find(({ quiz }) => quiz.id === quizId);
            if (sourceQuiz) {
              const roundKey = roundKeys[roundType];
              const question = sourceQuiz.quiz.rounds?.[roundKey]?.questions?.[parseInt(idx)];
              if (question) {
                // Create a deep copy with new ID
                const newQuestion = JSON.parse(JSON.stringify(question));
                newQuestion.id = Date.now() + questionsToAdd.length;
                questionsToAdd.push(newQuestion);
              }
            }
          });

          if (questionsToAdd.length > 0) {
            // Map round types to editor.data property names
            const editorRoundKey = roundType === 'connection' ? 'connections' : roundType;
            if (editor.data[editorRoundKey]) {
              editor.data[editorRoundKey].push(...questionsToAdd);
              editor.render();
              alert(`Added ${questionsToAdd.length} question${questionsToAdd.length > 1 ? 's' : ''} to your quiz!`);
              modal.remove();
            } else {
              alert('Error: Could not add questions. Please try again.');
              console.error('Invalid editor round key:', editorRoundKey);
            }
          }
        };
      }
    };

    // ----------------------------------------
    // EDITOR / QUIZ BUILDER
    // ----------------------------------------

    const editModeBtn = document.getElementById("editModeBtn");
    const setupModeBtn = document.getElementById("setupModeBtn");
    const helpBtn = document.getElementById("helpBtn");
    const boardShell = document.querySelector(".board-shell");
    const editorView = document.getElementById("editorView");

    const editor = {
      data: {
        connections: [],
        sequence: [],
        vowels: []
      },

      glyphOrder: ["lion", "water", "flax", "eye", "two-reeds", "horned-viper"],

      initializeEmptyRounds() {
        // Ensure connections round has 6 questions, adding empty ones if needed
        while (editor.data.connections.length < 6) {
          const i = editor.data.connections.length;
          editor.data.connections.push({
            id: Date.now() + i,
            glyph: editor.glyphOrder[i],
            code: "",
            title: "",
            type: "connection",
            clues: ["", "", "", ""],
            answer: "",
            explanation: ""
          });
        }
        
        // Ensure sequence round has 6 questions, adding empty ones if needed
        while (editor.data.sequence.length < 6) {
          const i = editor.data.sequence.length;
          editor.data.sequence.push({
            id: Date.now() + 100 + i,
            glyph: editor.glyphOrder[i],
            code: "",
            title: "",
            type: "sequence",
            clues: ["", "", ""],
            answer: "",
            explanation: ""
          });
        }
        
        // Ensure vowels round has 6 questions, adding empty ones if needed (no glyphs needed)
        while (editor.data.vowels.length < 6) {
          const i = editor.data.vowels.length;
          editor.data.vowels.push({
            id: Date.now() + 200 + i,
            glyph: "",
            code: "",
            title: "",
            type: "vowels",
            clues: [""],
            answer: "",
            explanation: ""
          });
        }
      },

      toggleMode(mode) {
        if (mode === "play") {
          boardShell.style.display = "block";
          editorView.classList.remove("active");
          editModeBtn.classList.remove("active");
          setupModeBtn.classList.remove("active");
        } else {
          boardShell.style.display = "none";
          editorView.classList.add("active");
          editModeBtn.classList.add("active");
          setupModeBtn.classList.remove("active");
          populateEditorLoadSelect();
          editor.initializeEmptyRounds();
          editor.render();
        }
      },

      addQuestion(roundType) {
        const nextGlyphIndex = editor.data[roundType].length % 6;
        const newQuestion = {
          id: Date.now(),
          glyph: roundType === "vowels" ? "" : editor.glyphOrder[nextGlyphIndex],
          code: "",
          title: "",
          type: roundType === "connections" ? "connection" : roundType,
          clues: roundType === "connections" ? ["", "", "", ""] : roundType === "vowels" ? [""] : ["", "", ""],
          answer: "",
          explanation: ""
        };
        editor.data[roundType].push(newQuestion);
        editor.render();
      },

      duplicateQuestion(roundType, id) {
        const original = editor.data[roundType].find(q => q.id === id);
        if (!original) return;
        
        const duplicate = JSON.parse(JSON.stringify(original));
        duplicate.id = Date.now();
        duplicate.title = duplicate.title ? duplicate.title + " (copy)" : "";
        
        // Insert after the original
        const index = editor.data[roundType].findIndex(q => q.id === id);
        editor.data[roundType].splice(index + 1, 0, duplicate);
        
        editor.render();
      },

      removeQuestion(roundType, id) {
        editor.data[roundType] = editor.data[roundType].filter(q => q.id !== id);
        editor.render();
      },

      updateQuestion(roundType, id, field, value) {
        const q = editor.data[roundType].find(x => x.id === id);
        if (q) {
          q[field] = value;
        }
      },

      updateClue(roundType, qId, clueIndex, value) {
        const q = editor.data[roundType].find(x => x.id === qId);
        if (q && q.clues) {
          q.clues[clueIndex] = value;
        }
      },

      render() {
        editor.renderRound("connections", "connectionsQuestions");
        editor.renderRound("sequence", "sequencesQuestions");
        editor.renderRound("vowels", "vowelsQuestions");
        // Note: Reuse buttons are now in the HTML and call quizManager.showReuseModal()
      },

      renderRound(roundType, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const questions = editor.data[roundType];

        const glyphNames = {
          "lion": "Lion",
          "water": "Water",
          "flax": "Flax",
          "eye": "Eye",
          "two-reeds": "Two Reeds",
          "horned-viper": "Viper"
        };

        questions.forEach((q, idx) => {
          const div = document.createElement("div");
          div.className = "question-item";
          div.draggable = true;
          div.dataset.questionId = q.id;
          div.dataset.roundType = roundType;
          
          // Drag and drop handlers
          div.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', div.innerHTML);
            div.style.opacity = '0.4';
            e.dataTransfer.setData('questionId', q.id);
            e.dataTransfer.setData('roundType', roundType);
          });
          
          div.addEventListener('dragend', (e) => {
            div.style.opacity = '1';
          });
          
          div.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            div.style.borderTop = '3px solid var(--accent)';
          });
          
          div.addEventListener('dragleave', (e) => {
            div.style.borderTop = '';
          });
          
          div.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            div.style.borderTop = '';
            
            const draggedId = e.dataTransfer.getData('questionId');
            const draggedRoundType = e.dataTransfer.getData('roundType');
            
            // Only allow reordering within same round
            if (draggedRoundType !== roundType) return;
            
            const draggedIndex = questions.findIndex(q => q.id == draggedId);
            const dropIndex = idx;
            
            if (draggedIndex !== -1 && draggedIndex !== dropIndex) {
              // Remove from old position
              const [movedQuestion] = questions.splice(draggedIndex, 1);
              // Insert at new position
              questions.splice(dropIndex, 0, movedQuestion);
              // Re-render
              editor.render();
            }
          });
          
          const dragHandle = document.createElement("div");
          dragHandle.style.cssText = "cursor:grab;padding:0 0.5rem;color:var(--text-muted);font-size:1.2rem;user-select:none;";
          dragHandle.innerHTML = "⋮⋮";
          dragHandle.title = "Drag to reorder";
          
          const textDiv = document.createElement("div");
          textDiv.className = "question-item-text";
          const displayTitle = q.title || (q.glyph ? glyphNames[q.glyph] : `Question ${idx + 1}`);
          const icon = q.glyph ? `<img src="glyph-${q.glyph}.png" alt="${q.glyph}" style="width:24px;height:24px;object-fit:contain;margin-right:0.4rem;vertical-align:middle;">` : "";
          const answerPreview = q.answer ? q.answer.substring(0, 50) + (q.answer.length > 50 ? '...' : '') : "No answer yet";
          textDiv.innerHTML = `${icon}<strong>${displayTitle}</strong><br><small style="color:var(--text-muted);">${answerPreview}</small>`;
          
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "question-item-actions";
          
          const editBtn = document.createElement("button");
          editBtn.className = "btn-secondary btn-sm";
          editBtn.textContent = "Edit";
          editBtn.onclick = () => editor.editQuestion(roundType, q.id);
          
          const dupBtn = document.createElement("button");
          dupBtn.className = "btn-secondary btn-sm";
          dupBtn.textContent = "Duplicate";
          dupBtn.title = "Create a copy of this question";
          dupBtn.onclick = () => editor.duplicateQuestion(roundType, q.id);
          
          const delBtn = document.createElement("button");
          delBtn.className = "btn-danger btn-sm";
          delBtn.textContent = "Delete";
          delBtn.onclick = () => {
            if (confirm('Delete this question?')) {
              editor.removeQuestion(roundType, q.id);
            }
          };
          
          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(dupBtn);
          actionsDiv.appendChild(delBtn);
          
          div.appendChild(dragHandle);
          div.appendChild(textDiv);
          div.appendChild(actionsDiv);
          
          container.appendChild(div);
        });
      },

      editQuestion(roundType, qId) {
        const q = editor.data[roundType].find(x => x.id === qId);
        if (!q) return;

        const cluesLabel = roundType === "vowels" ? "Missing vowel clues (one per line, up to 3)" : "Clues (one per line)";

        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100;
        `;

        const content = document.createElement("div");
        content.style.cssText = `
          background: #020617;
          border: 1px solid #1e293b;
          border-radius: 1rem;
          padding: 2rem;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        `;

        const glyphSelector = roundType === 'vowels' ? '' : `
          <div class="form-group">
            <label>Glyph Symbol</label>
            <select onchange="editor.updateQuestion('${roundType}', ${q.id}, 'glyph', this.value)" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
              <option value="lion" ${q.glyph === 'lion' ? 'selected' : ''}>🦁 Lion</option>
              <option value="water" ${q.glyph === 'water' ? 'selected' : ''}>💧 Water</option>
              <option value="flax" ${q.glyph === 'flax' ? 'selected' : ''}>🌾 Flax</option>
              <option value="eye" ${q.glyph === 'eye' ? 'selected' : ''}>👁️ Eye</option>
              <option value="two-reeds" ${q.glyph === 'two-reeds' ? 'selected' : ''}>🎋 Two Reeds</option>
              <option value="horned-viper" ${q.glyph === 'horned-viper' ? 'selected' : ''}>🐍 Horned Viper</option>
            </select>
          </div>
        `;

        content.innerHTML = `
          <h2 style="color: var(--accent); margin-bottom: 1rem;">Edit Question</h2>

          ${glyphSelector}

          <div class="form-group">
            <label>Title / Topic</label>
            <input type="text" value="${q.title || ''}" onchange="editor.updateQuestion('${roundType}', ${q.id}, 'title', this.value)" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
          </div>

          <div class="form-group">
            <label>${cluesLabel}</label>
            <div id="clueRows-${roundType}-${q.id}" style="display:flex;flex-direction:column;gap:0.5rem;"></div>
            <small style="color:var(--text-muted);display:block;margin-top:0.35rem;">${roundType === 'vowels' ? 'For vowels: Enter the missing vowel clue and its answer for each line.' : 'Paste images directly into the image box or paste an image URL.'}</small>
          </div>

          ${roundType !== 'vowels' ? `<div class="form-group">
            <label>Answer / Connection</label>
            <input type="text" value="${q.answer}" onchange="editor.updateQuestion('${roundType}', ${q.id}, 'answer', this.value)" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);">
          </div>` : ''}

          <div class="form-group">
            <label>Explanation (Optional)</label>
            <textarea onchange="editor.updateQuestion('${roundType}', ${q.id}, 'explanation', this.value)" style="width:100%;padding:0.4rem;background:#020617;border:1px solid #1f2937;border-radius:0.5rem;color:var(--text-main);min-height:60px;">${q.explanation || ''}</textarea>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
            <button class="btn-secondary" data-close-modal>Close</button>
            <button class="btn-primary" data-save-modal>Save</button>
          </div>
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
        content.querySelector('[data-close-modal]').addEventListener('click', () => modal.remove());
        content.querySelector('[data-save-modal]').addEventListener('click', () => {
          modal.remove();
          editor.render();
        });

        // Build per-clue rows with text + image paste support
        const clueWrap = content.querySelector(`#clueRows-${roundType}-${q.id}`);
        if (clueWrap) {
          const existing = q.clues || [];
          const desiredCount = roundType === "vowels" ? Math.max(existing.length || 0, 3) : Math.max(existing.length || 0, 4);

          const normalize = (idx) => {
            const c = existing[idx];
            if (c && typeof c === "object") {
              return { text: c.text || "", img: c.img || "", answer: c.answer || "" };
            }
            return { text: c || "", img: "", answer: "" };
          };

          const syncClues = () => {
            const rows = Array.from(clueWrap.querySelectorAll("[data-clue-row]"));
            const merged = rows.map(row => {
              const t = row.querySelector("[data-clue-text]")?.value.trim() || "";
              const img = row.querySelector("[data-clue-img]")?.value.trim() || "";
              const ans = row.querySelector("[data-clue-answer]")?.value.trim() || "";
              
              if (roundType === "vowels" && ans) {
                // For vowels, include answer in the clue object
                return { text: t, answer: ans };
              } else if (img) {
                return { text: t, img };
              }
              return t;
            }).filter(x => (typeof x === "string" ? x.length > 0 : (x.text || x.img || x.answer)));
            editor.updateQuestion(roundType, q.id, "clues", merged);
          };

          const handlePasteImage = (e, input) => {
            const items = e.clipboardData?.items;
            if (!items) return;
            for (const item of items) {
              if (item.type && item.type.startsWith("image/")) {
                e.preventDefault();
                const file = item.getAsFile();
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                  input.value = ev.target.result;
                  input.dispatchEvent(new Event("input", { bubbles: true }));
                };
                reader.readAsDataURL(file);
                break;
              }
            }
          };

          clueWrap.innerHTML = "";
          for (let i = 0; i < desiredCount; i++) {
            const { text, img, answer } = normalize(i);
            const row = document.createElement("div");
            row.dataset.clueRow = "true";
            row.style.display = "grid";
            
            if (roundType === "vowels") {
              // For vowels: clue text | answer (no image field)
              row.style.gridTemplateColumns = "1fr 1fr";
              row.style.gap = "0.4rem";

              const txt = document.createElement("textarea");
              txt.value = text;
              txt.placeholder = `Clue ${i + 1} (e.g., CCR)`;
              txt.dataset.clueText = "true";
              attachAutoResize(txt);
              txt.addEventListener("input", syncClues);

              const ansInput = document.createElement("textarea");
              ansInput.value = answer;
              ansInput.placeholder = `Answer ${i + 1} (e.g., CICERO)`;
              ansInput.dataset.clueAnswer = "true";
              ansInput.style.height = "48px";
              attachAutoResize(ansInput);
              ansInput.addEventListener("input", syncClues);

              row.appendChild(txt);
              row.appendChild(ansInput);
            } else {
              // For connections/sequences: clue text | image
              row.style.gridTemplateColumns = "1fr 1fr";
              row.style.gap = "0.4rem";

              const txt = document.createElement("textarea");
              txt.value = text;
              txt.placeholder = `Clue ${i + 1} text`;
              txt.dataset.clueText = "true";
              attachAutoResize(txt);
              txt.addEventListener("input", syncClues);

              const imgInput = document.createElement("textarea");
              imgInput.value = img;
              imgInput.placeholder = `Clue ${i + 1} image (paste image or URL)`;
              imgInput.dataset.clueImg = "true";
              imgInput.style.height = "48px";
              imgInput.addEventListener("input", syncClues);
              imgInput.addEventListener("paste", (e) => handlePasteImage(e, imgInput));

              row.appendChild(txt);
              row.appendChild(imgInput);
            }
            
            clueWrap.appendChild(row);
          }
        }
      },

      save() {
        try {
          const quizName = document.getElementById("quizName").value;
          const quizYear = document.getElementById("editorYear").value;
          const quizId = document.getElementById("quizYear").value;

          if (!quizName || !quizYear || !quizId) {
            alert("Please fill in all fields: Quiz Name, Year, and Quiz ID");
            return;
          }

          // Helper to check if a clue has content (handles both string and object clues)
          const hasClueContent = (c) => {
            if (!c) return false;
            if (typeof c === 'string') return c.trim().length > 0;
            if (typeof c === 'object' && !Array.isArray(c)) {
              return !!(c.text && c.text.trim()) || !!(c.img && c.img.trim());
            }
            return false;
          };

          const newQuiz = {
            id: quizId,
            name: quizName,
            rounds: {
              connection: {
                label: "Round 1 � Connectiones",
                questions: editor.data.connections.filter(q => q.title || q.answer || (q.clues && q.clues.some(hasClueContent)))
              },
              sequence: {
                label: "Round 2 � Quid Sequitur?",
                questions: editor.data.sequence.filter(q => q.title || q.answer || (q.clues && q.clues.some(hasClueContent)))
              },
              vowels: {
                label: "Round 3 � Vocalibus Desunt",
                questions: editor.data.vowels.filter(q => q.title || q.answer || (q.clues && q.clues.some(hasClueContent)))
              }
            }
          };

          // Save version to history before saving
          quizManager.saveVersion(quizName, editor.data);

          // Add to correct year in quizData
          upsertQuiz(parseInt(quizYear), newQuiz);

          // Save to localStorage for persistence
          try {
            localStorage.setItem("customQuizzes", JSON.stringify(quizData.years));
            alert("Quiz saved successfully!\n\nYour quiz is now available to play.");
            populateEditorLoadSelect();
          } catch (e) {
            if (e.name === 'QuotaExceededError') {
              alert("⚠️ STORAGE WARNING ⚠️\n\nQuiz saved to memory but could not be saved permanently due to storage quota exceeded.\n\nYour quiz IS available to play NOW, but will be LOST when you:\n• Refresh the page\n• Close the browser\n\nRECOMMENDATIONS:\n1. Export your quiz data using Setup > Export All Data (save to file)\n2. Use image URLs instead of pasting images directly\n3. Play your quiz now before closing the browser\n\nThe quiz is currently loaded and playable.");
              console.error('Storage quota exceeded:', e);
              // Still populate the editor select so the quiz shows as available
              populateEditorLoadSelect();
            } else {
              throw e;
            }
          }
        } catch (error) {
          console.error("Error saving quiz:", error);
          alert("Error saving quiz: " + error.message);
        }
      },

      saveAndPlay() {
        editor.save();
        
        const quizYear = document.getElementById("editorYear").value;
        const quizId = document.getElementById("quizYear").value;
        
        if (!quizYear || !quizId) return;
        
        // Switch to play mode and select the quiz
        editor.toggleMode("play");
        currentYear = parseInt(quizYear);
        currentYearGroupId = quizId;
        currentQuestionIndex = null;
        revealedClues = 0;
        renderAll();
      },

      clear() {
        if (confirm("Clear all questions and reset to 6 empty questions per round?")) {
          editor.data = { connections: [], sequence: [], vowels: [] };
          editor.initializeEmptyRounds();
          document.getElementById("quizName").value = "";
          document.getElementById("quizYear").value = "";
          editor.render();
        }
      },

      loadFromQuiz(quiz, year) {
        if (!quiz) return;
        // Deep clone rounds to avoid mutating stored data
        const cloneRound = (key) => JSON.parse(JSON.stringify(quiz.rounds?.[key]?.questions || []));
        editor.data = {
          connections: cloneRound("connection"),
          sequence: cloneRound("sequence"),
          vowels: cloneRound("vowels")
        };
        
        // Ensure we have 6 questions per round
        editor.initializeEmptyRounds();
        
        document.getElementById("quizName").value = quiz.name || "";
        document.getElementById("editorYear").value = year || "";
        document.getElementById("quizYear").value = quiz.id || "";
        editor.render();
      }
    };

    // Mode toggle event listeners
    editModeBtn.addEventListener("click", () => {
      // Password protection for Create mode
      const password = prompt("Enter password to access Create mode:");
      if (password === "ALVK") {
        editor.toggleMode("edit");
      } else if (password !== null) {
        alert("Incorrect password. Create mode is locked.");
      }
    });
    setupModeBtn.addEventListener("click", () => showTeacherSetup());
    
    if (helpBtn) {
      helpBtn.addEventListener("click", showHelpGuide);
    }

    // Load quiz into editor
    if (loadQuizBtn) {
      loadQuizBtn.addEventListener("click", () => {
        const id = editorLoadSelect?.value;
        if (!id) {
          alert("Select a quiz to load.");
          return;
        }
        const found = getQuizById(id);
        if (!found) {
          alert("Quiz not found.");
          return;
        }
        editor.loadFromQuiz(found.quiz, found.year);
        alert("Quiz loaded into editor.");
      });
    }

    // Delete quiz
    if (deleteQuizBtn) {
      deleteQuizBtn.addEventListener("click", () => {
        const id = editorLoadSelect?.value;
        if (!id) {
          alert("Select a quiz to delete.");
          return;
        }
        const found = getQuizById(id);
        if (!found) {
          alert("Quiz not found.");
          return;
        }
        if (!confirm(`Delete quiz "${found.quiz.name}"? This cannot be undone.`)) return;
        // Remove from quizData
        quizData.years[found.year] = (quizData.years[found.year] || []).filter(q => q.id !== id);
        // Persist custom quizzes
        try { localStorage.setItem("customQuizzes", JSON.stringify(quizData.years)); } catch(e){}
        populateEditorLoadSelect();
        // Clear editor if the deleted quiz was loaded
        if (document.getElementById("quizYear").value === id) {
          editor.data = { connections: [], sequence: [], vowels: [] };
          document.getElementById("quizName").value = "";
          document.getElementById("editorYear").value = "";
          document.getElementById("quizYear").value = "";
          editor.render();
        }
        alert("Quiz deleted.");
      });
    }

    // Load saved quizzes from localStorage
    const saved = localStorage.getItem("customQuizzes");
    if (saved) {
      try {
        const customYears = JSON.parse(saved);
        Object.keys(customYears).forEach(year => {
          customYears[year].forEach(quiz => {
            upsertQuiz(parseInt(year, 10), quiz);
          });
        });
      } catch (e) {
        console.error("Error loading saved quizzes:", e);
      }
    }
    populateEditorLoadSelect();

    // ----------------------------------------
    // TIMER EVENT LISTENERS
    // ----------------------------------------

    timerStartBtn.addEventListener("click", startTimer);
    timerPauseBtn.addEventListener("click", pauseTimer);
    timerResetBtn.addEventListener("click", resetTimer);

    // Team selection buttons
    team1Btn.addEventListener('click', () => setCurrentTeam('team1'));
    team2Btn.addEventListener('click', () => setCurrentTeam('team2'));
    teamSetupBtn.addEventListener('click', openTeamSetup);
    if (newGameBtn) {
      newGameBtn.addEventListener('click', showEndOfQuizSummary);
    }
    
    // Undo button
    if (undoBtn) {
      undoBtn.addEventListener('click', performUndo);
    }
    
    // Fullscreen button
    if (fullscreenBtn) {
      fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => {
            console.log('Fullscreen request failed:', err);
          });
        } else {
          document.exitFullscreen();
        }
      });
      
      // Update button icon when fullscreen changes
      document.addEventListener('fullscreenchange', () => {
        const svg = fullscreenBtn.querySelector('svg');
        if (document.fullscreenElement) {
          svg.innerHTML = '<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>';
        } else {
          svg.innerHTML = '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
        }
      });
    }

    // Keyboard shortcuts: 1/2 to select team, c to mark correct, x to mark incorrect
    document.addEventListener('keydown', (e) => {
      if (e.key === '1') setCurrentTeam('team1');
      if (e.key === '2') setCurrentTeam('team2');
      if (e.key.toLowerCase() === 'c') {
        // simulate correct button press on current question
        const q = getCurrentQuestion();
        if (q) {
          const maxClues = q.clues?.length || 0;
          const safeRevealed = Math.min(revealedClues || 1, maxClues);
          let possiblePoints;
          if (currentRoundKey === 'vowels') {
            possiblePoints = 1;
            awardPoints(currentTeam, possiblePoints, 'vowels');
            advanceVowelsClue();
            return;
          } else {
            const pointsByClue = [5,3,2,1];
            possiblePoints = pointsByClue[Math.max(0, Math.min(3, safeRevealed - 1))] || 1;
            awardPoints(currentTeam, possiblePoints, currentRoundKey);
          }
          q._showAnswer = true;
          hideQuestionTimer();
          renderAll();
        }
      }
      if (e.key.toLowerCase() === 'x') {
        // mark incorrect -> reveal remaining clues so opponent can try
        const q = getCurrentQuestion();
        if (q) {
          if (currentRoundKey === 'vowels') {
            advanceVowelsClue();
          } else {
            revealedClues = Math.max(revealedClues || 1, q.clues.length);
            renderAll();
          }
        }
      }
    });

    // State persistence functions
    function saveAppState() {
      try {
        const state = {
          onStartPage,
          currentYear,
          currentYearGroupId,
          currentRoundKey,
          currentQuestionIndex,
          revealedClues,
          editorMode: editor?.currentMode || null,
          timestamp: Date.now()
        };
        sessionStorage.setItem('coniungiteAppState', JSON.stringify(state));
      } catch (e) {
        console.error('Failed to save app state:', e);
      }
    }

    function loadAppState() {
      try {
        const stateStr = sessionStorage.getItem('coniungiteAppState');
        if (!stateStr) return false;
        
        const state = JSON.parse(stateStr);
        
        // Don't restore if state is too old (more than 1 hour)
        if (Date.now() - state.timestamp > 3600000) {
          sessionStorage.removeItem('coniungiteAppState');
          return false;
        }
        
        // If not on start page, verify the quiz data exists before restoring
        if (!state.onStartPage) {
          if (state.currentYearGroupId) {
            // Check if the quiz still exists
            const quiz = getCurrentYearGroupById(state.currentYearGroupId);
            if (!quiz) {
              console.log('Quiz no longer exists, returning to home');
              sessionStorage.removeItem('coniungiteAppState');
              return false;
            }
          }
        }
        
        // Restore state variables
        onStartPage = state.onStartPage;
        currentYear = state.currentYear;
        currentYearGroupId = state.currentYearGroupId;
        currentRoundKey = state.currentRoundKey;
        currentQuestionIndex = state.currentQuestionIndex;
        revealedClues = state.revealedClues;
        
        // Restore editor mode if applicable
        if (state.editorMode && editor) {
          editor.currentMode = state.editorMode;
          // Restore editor data if in edit mode
          if (state.editorMode === 'edit' && state.currentYearGroupId) {
            const quiz = getCurrentYearGroupById(state.currentYearGroupId);
            if (quiz) {
              editor.data = {
                connections: quiz.rounds?.connection?.questions || [],
                sequence: quiz.rounds?.sequence?.questions || [],
                vowels: quiz.rounds?.vowels?.questions || []
              };
              editor.quizName = quiz.name;
              editor.selectedYear = state.currentYear;
              editor.editingQuizId = state.currentYearGroupId;
              // Switch to editor view
              setTimeout(() => {
                if (typeof editor.toggleMode === 'function') {
                  editor.toggleMode('edit');
                }
              }, 0);
            }
          }
        }
        
        console.log('Restored app state:', state);
        return true;
      } catch (e) {
        console.error('Failed to load app state:', e);
        return false;
      }
    }

    // Initialize display: load persisted scores then update
    try { loadScoresFromStorage(); } catch (e) {}
    updateScoreDisplay();

    // Try to restore previous state, otherwise start fresh
    const stateRestored = loadAppState();
    
    // Initial render
    renderAll();
  </script>
</body>
</html>

